
<!-- :hover doesn't work with the doctype tag..?
 <!DOCTYPE html>
 -->

<html>
    <head>
        
        <title>Bamse</title>
		
        <style type="text/css">
			
			* {
				padding:0;
				margin:0;
				position:absolute;
			}
			
			html, body {
				height:100%;
				width:100%;
			}
			
			#wrap {
				width:100%;
				height:100%;
			}
			
			#sidebar-left {
				left:0px;
				top:0px;
				width:200px;
				height:100%;
				/*background-color:lightblue;*/
			}
			
			#sidebar-right {
				right:0px;
				top:0px;
				width:200px;
				height:100%;
				/*background-color:lightblue;*/
			}
			
			#content {
				position:absolute;
				left:200px;
				right:200px;
				top:0;
				bottom:0;
				/*background-color:lightgreen;*/
			}
			
			#video-container {
				position:absolute;
				width:100%;
				top:1em;
				bottom:13em;
				/*background-color:pink;*/
			}
			#large-video {
				width:100%;
				height:100%;
			}
			
			#room-link {
				text-align:center;
				position:absolute;
				margin:0 10% 0 10%;
				bottom:11.5em;
				width:80%;
			}
		
			#text-chat {
				position:absolute;
				margin:0 10% 0 10%;
				width:80%;
				bottom:0;
				height:12em;
				/*background-color:red;*/
			}
			
			#chat-area {
				position:absolute;
				bottom:3.5em;
				height:12.5em;
				width:100%;
			}
			
			#chat-input {
				position:absolute;
				bottom:0.5em;
				width:80%;
				height:2.5em;
			}
			
			#send-button {
				position:absolute;
				bottom:0.5em;
				right:0;
				width:18%;
				height:2.5em;
			}
			</style>
		
		
		<script type="text/javascript" src="/js/lib/jquery.min.js"></script>
		<script type="text/javascript" src="js/lib/erizo.js"></script>
		
		<script type="text/javascript" src="/js/c-master.js"></script>
		<script type="text/javascript" src="/js/bamse.js"></script>
		<script type="text/javascript" src="/js/lib/webgl-utils.js"></script>
		
		<!-- VideoJS -->
		<link type="text/css" rel="stylesheet" href="/js/lib/videojs-youtube/lib/video-js.css"/>
		<script type="text/javascript" src="/js/lib/videojs-youtube/vjs-concat.js"></script>
		
		<script>
			
			var file;
			var nextEvent, lastTimeUpdate = 0, eventIndex = 0;
			var animFrameId;
			
			window.onload = function() {
				
				var options = {
					techOrder : ["html5", "flash", "youtube" ],
					flash : {
						swf : "lib/videojs-youtube/lib/video-js.swf"
					}
				};
				videojs("the-video", options, initializeVideoPlayer);
				
				var textArea = document.getElementById("chat-input");
				textArea.onkeypress = function(evt) {
					if (evt.keyCode === 13) {
						sendChatMessage();
						return false;
					}
					return true;
				};
				
				Master.on("init", function() {
							loadVideo(bamse);
						
						  var link = document.getElementById("room-link");
						  link.innerHTML = "Link"; // VAd ska det STÅÅåå
						  link.href = "/bamse-client.html?room=" + Master.getRoomId();
						  });
				Master.on("user-added", function(e) {
							if (file) {
								Master.sendMessage(e.userId, { type:"file", file:file });
							}
						  });
				Master.on("user-left", function(e) {
						  });
				Master.on("message", messageHandler);
				Master.init();
			}
		
			function messageHandler(senderId, message) {
				if (message.type === "msg") {
					showChatMessage(senderId, message);
				}
			}
			
			// ********************************
			// VideoJS event handlers
			// ********************************
			
			function onPlay() {
			}
		
			function onPause() {
			}
			
			function onTimeUpdate() {
				
				// Round time to one decimal
				var currentTime = videoPlayer.currentTime();
				
				// Find the correct event index if the time skip is large
				if (Math.abs(currentTime - lastTimeUpdate) > 1) {
					nextEvent = findNextEvent(file.events, currentTime);
				}
				
				if (nextEvent && currentTime >= nextEvent.time) {
					Master.sendMessage("all", nextEvent);
					eventIndex++;
					nextEvent = file.events[eventIndex];
				}
				
				lastTimeUpdate = currentTime;
			}
			
			function loadVideo(obj) {
				// Embed with VideoJS
				videoPlayer.src(obj.src);
				Master.sendMessage("all", { type:"file", file:file });
				eventIndex = 0;
				lastTimeUpdate = 0;
				nextEvent = obj.events[0];
				file = obj;
			}
		
			function resizeVideoPlayer() {
				
				if (!videoPlayer) {
					return;
				}
				
				var container = $("#video-container"),
					width = container.innerWidth(),
					height = container.innerHeight();
				$("#the-video").css({
									marginTop: -height * 0.5,
									marginLeft: -width * 0.5,
									});
									
				videoPlayer.dimensions(width, height);
			}
		
			function initializeVideoPlayer() {
				
				videoPlayer = this;
				
				$("#the-video").css({
									position:"absolute",
									top:"50%",
									left:"50%"
									});

				$(window).resize(resizeVideoPlayer);
				resizeVideoPlayer();
									
				// Attach event handlers
				videoPlayer.on("play", onPlay);
				videoPlayer.on("pause", onPause);
				videoPlayer.on("timeupdate", onTimeUpdate);
			};
		
			
			function findNextEvent(eventList, timestamp) {
				// Linear search (change to binary or something)
				for (var i = 0; i < eventList.length; i++) {
					var event = eventList[i];
					if (timestamp < event.time) {
						eventIndex = i;
						return event;
					}
				}
				return null;
			}
		
		
			// ********************************
			// Text chat stuff (shouldn't be here)
			// ********************************
			
			function showChatMessage(senderId, message) {
				
				if (!message) {
					return;
				}
				
				var textOut = document.getElementById("chat-area"),
					sender = (senderId === "You") ? "You" : streams[senderId].username;
				textOut.value = textOut.value + "\n" + sender + " said: " + message;
				textOut.scrollTop = textOut.scrollHeight;
			}
			
			function sendChatMessage() {
				
				var textIn = document.getElementById("chat-input"),
					message = textIn.value.trim();
				
				if (message) {
					showChatMessage("You", message);
					Master.sendMessage("all", { type:"msg", data:message });
				}
				
				textIn.value = "";
			}
			
			</script>
        
    </head>
	
	<body>
		
		<div id="wrap">
			
			<div id="sidebar-left"></div>
			
			<div id="content">
				<div id="video-container">
					<video id="the-video" controls class='video-js vjs-default-skin'></video>
				</div>
				<a href="#" id="room-link"></a>
				<div id="text-chat">
					<textarea id="chat-area" disabled=true>Text chat!</textarea>
					<textarea id="chat-input"></textarea>
					<button id="send-button" onclick="sendChatMessage();">Send</button>
				</div>
			</div>
			
			<div id="sidebar-right"></div>
			
		</div>
    </body>
	
</html>


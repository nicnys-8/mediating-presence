
<!DOCTYPE html>

<html>
    <head>
        
        <title>Bamse</title>
		
        <style type="text/css">
			
			html, body {
				height:100%;
				width:100%;
			}
			
			#wrap {
				width:100%;
				height:100%;
			}
			
			#sidebar-left {
				left:0px;
				top:0px;
				width:200px;
				height:100%;
				/*background-color:lightblue;*/
			}
			
			#sidebar-right {
				right:0px;
				top:0px;
				width:200px;
				height:100%;
				/*background-color:lightblue;*/
			}
			
			#content {
				position:absolute;
				left:200px;
				right:200px;
				top:0;
				bottom:0;
				/*background-color:lightgreen;*/
			}
			
			#video-container {
				position:absolute;
				width:100%;
				top:1em;
				bottom:13em;
				/*background-color:pink;*/
			}
			#large-video {
				width:100%;
				height:100%;
			}
			
			#room-link {
				text-align:center;
				position:absolute;
				margin:0 10% 0 10%;
				bottom:11.5em;
				width:80%;
			}
			
			#text-chat {
				position:absolute;
				margin:0 10% 0 10%;
				width:80%;
				bottom:0;
				height:12em;
				/*background-color:red;*/
			}
			
			#chat-area {
				position:absolute;
				bottom:3.5em;
				height:12.5em;
				width:100%;
			}
			
			#chat-input {
				position:absolute;
				bottom:0.5em;
				width:80%;
				height:2.5em;
			}
			
			#send-button {
				position:absolute;
				bottom:0.5em;
				right:0;
				width:18%;
				height:2.5em;
			}
		</style>
		
		
		<script type="text/javascript" src="/js/lib/jquery.min.js"></script>
		<script type="text/javascript" src="js/lib/erizo.js"></script>
		
		<script type="text/javascript" src="/js/c-master.js"></script>
		<script type="text/javascript" src="/js/bamse.js"></script>
		<script type="text/javascript" src="/js/lib/webgl-utils.js"></script>
		
		<!-- VideoJS -->
		<link type="text/css" rel="stylesheet" href="/js/lib/videojs-youtube/lib/video-js.css"/>
		<script type="text/javascript" src="/js/lib/videojs-youtube/vjs-concat.js"></script>
		
		<script>
			
			var file;
			var nextEvent, lastTimeUpdate = 0, eventIndex = 0;
			var animFrameId;
			
			var users = {};
			var activeEvents = {};
			
			function User(id) {
				
				var row = document.createElement("tr"),
					nameCell = document.createElement("td"),
					scoreCell = document.createElement("td");

				nameCell.innerHTML = id;
				scoreCell.innerHTML = 0;
				
				row.appendChild(nameCell);
				row.appendChild(scoreCell);
				
				this.id = id;
				this.score = 0;
				this.tableRow = row;
				this.nameCell = nameCell;
				this.scoreCell = scoreCell;
				
				this.addPoints = function(points) {
					this.score += points;
					this.scoreCell.innerHTML = this.score;
				};
			}
		
			function ActiveEvent(startTime, TTL) {
				
				var points = Master.getUserIds().length,
					responses = {};
				
				this.id = (Math.random() * 10e16).toFixed(0).toString();
				this.startTime = startTime;
				this.endTime = startTime + TTL;
				
				this.onResponse = function(userId) {
					if (!responses.hasOwnProperty(userId)) {
						responses[userId] = points;
						users[userId].addPoints(points);
						points--;
					}
				}
			}
		
			window.onload = function() {
				
				var options = {
					techOrder : ["html5", "flash", "youtube" ],
					flash : {
						swf : "lib/videojs-youtube/lib/video-js.swf"
					}
				};
				videojs("the-video", options, initializeVideoPlayer);
				
				var textArea = document.getElementById("chat-input");
				textArea.onkeypress = function(evt) {
					if (evt.keyCode === 13) {
						sendChatMessage();
						return false;
					}
					return true;
				};
				
				Master.on("init", function() {
						  loadVideo(bamse);
						  
						  var link = document.getElementById("room-link");
						  var href = "/bamse-client.html?room=" + Master.getRoomId();
						  link.innerHTML = "http://" + location.host + href;
						  link.href = href;
						  });
				Master.on("user-added", function(e) {
						  
						  var userId = e.userId;
						  var user = new User(userId);
						  $("#score-table").append(user.tableRow);
						  users[userId] = user;
						  
						  if (file) {
							Master.sendMessage(userId, { type:"file", file:file });
						  }});
				Master.on("user-left", function(e) {
						  var user = users[e.userId];
						  if (user) {
							$(user.tableRow).remove();
						  }
						  delete users[e.userId];
						  });
				Master.on("message", messageHandler);
				Master.init();
			};
		
			function messageHandler(evt) {
				var message = evt.message;
				
				console.log(message);
				
				switch (message.type) {
					case "msg":
						showChatMessage(evt.userId, message.data);
						break;
					case "click":
						handleClickResponse(evt.userId, message.data.id);
						break;
				}
			}
			
			function handleClickResponse(userId, eventId) {
				var event = activeEvents[eventId];
				if (event) {
					event.onResponse(userId);
				}
			}
		
			// ********************************
			// VideoJS event handlers
			// ********************************
			
			function onPlay() {
			}
			
			function onPause() {
			}
			
			function onTimeUpdate() {
				
				// Round time to one decimal
				var currentTime = videoPlayer.currentTime();
				
				// Remove ActiveEvents (that are no longer active:)
				for (var id in activeEvents) {
					var e = activeEvents[id];
					if (currentTime < e.startTime || currentTime > e.endTime) {
						delete activeEvents[id];
					}
				}
				
				// Find the correct event index if the time skip is large
				if (Math.abs(currentTime - lastTimeUpdate) > 2) {
					nextEvent = findNextEvent(file.events, currentTime);
				}
				
				// Dispatch an event if it's time to do so!
				if (nextEvent && currentTime >= nextEvent.time) {
					
					// Create an ActiveEvent if the event is "respondable"
					if (nextEvent.data && nextEvent.data.responseTime) {
						var ae = new ActiveEvent(nextEvent.time, nextEvent.data.responseTime);
						activeEvents[ae.id] = ae;
						nextEvent.data.responseId = ae.id;
					}
					
					Master.sendMessage("all", nextEvent);
					eventIndex++;
					
					nextEvent = file.events[eventIndex];
				}
				
				lastTimeUpdate = currentTime;
			}
			
			function loadVideo(obj) {
				// Embed with VideoJS
				videoPlayer.src(obj.src);
				Master.sendMessage("all", { type:"file", file:file });
				eventIndex = 0;
				lastTimeUpdate = 0;
				nextEvent = obj.events[0];
				file = obj;
			}
			
			function resizeVideoPlayer() {
				
				if (!videoPlayer) {
					return;
				}
				
				var ASPECT = 4 / 3,
					container = $("#video-container"),
					width = Math.min(container.innerWidth(), container.innerHeight() * ASPECT),
					height = width / ASPECT;
				$("#the-video").css({
									marginTop: -height * 0.5,
									marginLeft: -width * 0.5,
									});
									
				videoPlayer.dimensions(width, height);
			}
			
			function initializeVideoPlayer() {
				
				videoPlayer = this;
				
				$("#the-video").css({
									position:"absolute",
									top:"50%",
									left:"50%"
									});
									
				$(window).resize(resizeVideoPlayer);
				resizeVideoPlayer();
									
				// Attach event handlers
				videoPlayer.on("play", onPlay);
				videoPlayer.on("pause", onPause);
				videoPlayer.on("timeupdate", onTimeUpdate);
			}
			
			
			function findNextEvent(eventList, timestamp) {
				// Linear search (change to binary or something)
				for (var i = 0; i < eventList.length; i++) {
					var event = eventList[i];
					if (timestamp <= event.time) {
						eventIndex = i;
						return event;
					}
				}
				return null;
			}
			
			
			// ********************************
			// Text chat stuff (shouldn't be here)
			// ********************************
			
			function showChatMessage(senderId, message) {
				
				if (!message) {
					return;
				}
				
				var textOut = document.getElementById("chat-area");
				textOut.value = textOut.value + "\n" + senderId + " said: " + message;
				textOut.scrollTop = textOut.scrollHeight;
			}
			
			function sendChatMessage() {
				
				var textIn = document.getElementById("chat-input"),
				message = textIn.value.trim();
				
				if (message) {
					showChatMessage("Master", message);
					Master.sendMessage("all", { type:"msg", data:message });
				}
				
				textIn.value = "";
			}
		
		</script>
        
    </head>
	
	<body>
		
		<div id="wrap">
			
			<div id="sidebar-left">
				<table id="score-table" border="1">
					<tr>
						<th>User</th>
						<th>Score</th>
					</tr>
				</table>
			</div>
			
			<div id="content">
				<div id="video-container">
					<video id="the-video" controls class='video-js vjs-default-skin'></video>
				</div>
				<a href="#" id="room-link"></a>
				<div id="text-chat">
					<textarea id="chat-area" disabled=true>Text chat!</textarea>
					<textarea id="chat-input"></textarea>
					<button id="send-button" onclick="sendChatMessage();">Send</button>
				</div>
			</div>
			
			<div id="sidebar-right"></div>
			
		</div>
    </body>
	
</html>


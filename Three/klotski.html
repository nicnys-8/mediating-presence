<!doctype html>
<html lang="en" style="height:100%; width:100%;">
    <head>
        <title>Cube Game</title>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
                
                <script type="text/javascript" src="../js/lib/Three.js"></script>
                <script type="text/javascript" src="../js/mouse-interface.js"></script>
                <script type="text/javascript" src="../js/klotski-level.js"></script>
                <script type="text/javascript" src="../js/klotski-levels.js"></script>
                <script type="text/javascript" src="../js/klotski-blocks.js"></script>
                <script type="text/javascript" src="../js/particles.js"></script>
                
                <script type="text/javascript" src="../js/lib/zig.js"></script>
                
                <script type="text/javascript" src="../js/kinect-decoder.js"></script>
                <script type="text/javascript" src="../js/image-handling.js"></script>
                <script type="text/javascript" src="../js/kinect-touch-controller.js"></script>
                
                <script type="text/javascript" src="../js/geometry.js"></script>
                
                <script>
                    // Camera constants
                    const VIEW_ANGLE = 45;
                    const NEAR = 0.01;
                    const FAR = 100;
					
					var gameScreenWidth;
                    var gameScreenHeight;
                    var aspect;
                    
                    var container, scene, camera, renderer, controls;
                    var level;
                    
                    /**
                     Set up the scene
                     */
                    function init() {
                        
                        // Scene
                        scene = new THREE.Scene();
                        
                        // Container in which the game is placed
                        container = document.getElementById("container");
                        
                        gameScreenWidth = container.offsetWidth;
                        gameScreenHeight = container.offsetHeight;
                        aspect = gameScreenWidth / gameScreenHeight;
                        
                        // Renderer
                        renderer = new THREE.WebGLRenderer({antialias: true});
                        renderer.setSize(gameScreenWidth, gameScreenHeight);
                        
                        // Camera
                        camera = new THREE.PerspectiveCamera(VIEW_ANGLE, aspect, NEAR, FAR);
                        scene.add(camera);
                        camera.position.set(2, 2.5, 12);
                        
                        camera.lookAt(new THREE.Vector3(2, 2.5, 0));
                        
                        level = new KlotskiLevel(KlotskiLevels.level1, blockSnappedCallback);
                        scene.add(level);
                        
                        container.appendChild(renderer.domElement);
                                                
						window.onresize = function() {
							aspect = container.offsetWidth / container.offsetHeight;
							
							scene.remove(camera);
							
							camera = new THREE.PerspectiveCamera(VIEW_ANGLE, aspect, NEAR, FAR);
							camera.position.set(2, 2.5, 12);
							camera.lookAt(new THREE.Vector3(2, 2.5, 0));
							scene.add(camera);
							renderer.setSize(container.offsetWidth, container.offsetHeight);
						}
						
                        // Start listening for mouse clicks
                        document.addEventListener('mousedown', mouseDown, false);
                        document.addEventListener('mousemove', mouseMove, false);
                        document.addEventListener('mouseup', mouseUp, false);
                                                
                        // Kinect
                        initKinect();
                        
                        // Start the update loop
                        tick();
                    }
                    
                    
                    /**
                     Update loop
                     */
                    function tick() {
                        requestAnimationFrame(tick);
                        renderer.render(scene, camera)
                        level.tick();
                    }
                    
                    
                    /*---------------
                     ===| Kinect |===
                     --------------*/
                    const KINECT_DEPTH_WIDTH = 160;
                    const KINECT_DEPTH_HEIGHT = 120;
                    
                    var plugin;
                    var depthData = new Array(KINECT_DEPTH_WIDTH * KINECT_DEPTH_HEIGHT);
                    
                    
                    /**
                     Start retrieving and processing Kinect data
                     */
                    function initKinect() {
                        plugin = document.getElementById("ZigPlugin");
                        
                        var dJSON = localStorage.depthRef;
                        var TJSON = localStorage.transform;
                        
                        // If no transform data is found, return.
                        if (!dJSON || !TJSON) {
                            alert("Kinect not calibrated! Motion controls won't work...");
                            return;
                        }
                        
                        var depthRef = JSON.parse(dJSON);
                        var tData = JSON.parse(TJSON);
                        
                        var transform = new Geometry.Transform(tData[0], tData[1]);
                        kinectTouchController = new KinectTouchController(depthRef, transform);
                        
                        
                        // Start the video streams
                        plugin.requestStreams({updateDepth:true, updateImage:true});
                        // Start updating the canvases every new kinect frame
                        plugin.addEventListener("NewFrame", updateKinectData);
                    }
                    
                    
                    /**
                     Decode the latest depth image and update the touch controller 
                     accordingly
                     */
                    function updateKinectData() {
                        /* Take a snapshot from the Kinect depth video */
                        KinectDecoder.decodeDepth(plugin.depthMap, depthData);
                        kinectTouchController.update(depthData);
                    }
                    
                    /**
                     ...
                     */
                    function blockSnappedCallback(id, x, y) {
                        console.log("Snap! ID: " + id + " x: " + x + " y: " + y);
                    }
                    
                    /*---------------------
                     ===| Mouse Events |===
                     --------------------*/
                    
                    /**
                     Called whenever the left mouse button is clicked
                     */
                    function mouseDown(event) {
                        level.clickEvent(event.clientX, event.clientY);
                    }
                    
                    /**
                     Called whenever the mouse is moved
                     */
                    function mouseMove(event) {
                        level.moveEvent(event.clientX, event.clientY);
                    }
                    
                    
                    /**
                     Called when the left mouse button is released
                     */
                    function mouseUp(event) {
                        level.releaseEvent();
                    }
                    
                    </script>
                </head>
    
    <body style="overflow:hidden; margin:0px; height:100%; width:100%" onload="init()">
        
        <div id ="container" style="height:100%; width:100%;"> </div>
        
        <div id="pluginContainer">
            <object id="ZigPlugin" type="application/x-zig" width="0" height="0">
                <param name="onload" value="zigPluginLoaded">
                    </object>
        </div>
        
    </body>
</html>

<!doctype html>
<html lang="en" style="height:100%; width:100%;">
    <head>
        <title>Cube Game</title>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
                
                <script type="text/javascript" src="../js/tab-control.js"></script>
                <script type="text/javascript" src="../js/lib/Three.js"></script>
                <script type="text/javascript" src="../js/mouse-interface.js"></script>
                <script type="text/javascript" src="../js/klotski.js"></script>
                <script type="text/javascript" src="../js/klotski-blocks.js"></script>
                <script type="text/javascript" src="../js/particles.js"></script>
                <script type="text/javascript" src="../js/lib/zig.js"></script>
                <script type="text/javascript" src="../js/kinect-decoder.js"></script>
                <script type="text/javascript" src="../js/image-handling.js"></script>
                <script type="text/javascript" src="../js/kinect-touch-controller.js"></script>
                <script type="text/javascript" src="../js/geometry.js"></script>
                
                <script>
                    
                    var klotski;
                    
                    TabControl.onActivate = function() {
                        klotski.shouldRender = true;
                    };
                    
                    TabControl.onDeactivate = function() {
                        klotski.shouldRender = false;
                    };
                    
                    TabControl.onStreamAdded = function(stream) {
                    };
                    
                    TabControl.onStreamRemoved = function(stream) {
                    };
                    
                    TabControl.onDataReceived = function(senderId, packet) {
                        if (packet.dst == "klotski") {
                            klotski.externalBlockMove(packet.id,
                                                      packet.x,
                                                      packet.y);
                        }
                    };
                    
                    TabControl.onKinectProxyCreated = function(proxy) {
                    };
                    
                    TabControl.onLoad = function() {
                        var container = document.getElementById("klotskiContainer");
                        // Create the Klotski object
                        klotski = new Klotski(
                                              Klotski.level1,
                                              blockSnapped,
                                              container
                                              );
                        
                        // Start listening for mouse events
                        document.addEventListener('mousedown', onMouseDown, false);
                        document.addEventListener('mousemove', onMouseMove, false);
                        document.addEventListener('mouseup', onMouseUp, false);
                        
                        // Start the update loop
                        tick();
                    }
                    
                    /**
                     The update loop of the tab
                     */
                    function tick() {
                        requestAnimationFrame(tick);
                        klotski.updateScene();
                    }
                    
                    /**
                     Called when a Klotski block snaps to an even grid point
                     */
                    function blockSnapped(id, x, y) {
                        var message = {dst:"klotski", id:id, x:x, y:y};
                        message = JSON.stringify(message);
                        TabControl.sendData(message);
                    }
                    
                    /*---------------------
                     ===| Mouse Events |===
                     --------------------*/
                    /**
                     Called whenever the left mouse button is clicked
                     */
                    function onMouseDown(event) {
                        klotski.onMouseDown(event.clientX, event.clientY);
                    }
                    
                    /**
                     Called whenever the mouse is moved
                     */
                    function onMouseMove(event) {
                        klotski.onMouseMove(event.clientX, event.clientY);
                    }
                    
                    /**
                     Called when the left mouse button is released
                     */
                    function onMouseUp(event) {
                        klotski.onMouseUp(event.clientX, event.clientY);
                    }
                    
                    </script>
                </head>
    
    <body style="overflow:hidden; margin:0px; height:100%; width:100%">
        <div id ="klotskiContainer" style="height:100%; width:100%"> </div>
    </body>
</html>

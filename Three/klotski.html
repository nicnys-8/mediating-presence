<!doctype html>
<html lang="en">
    <head>
        <title>Cube Game</title>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
                
                <script type="text/javascript" src="../js/lib/Three.js"></script>
                <script type="text/javascript" src="../js/mouse-interface.js"></script>
                <script type="text/javascript" src="../js/klotski-level.js"></script>
                <script type="text/javascript" src="../js/klotski-blocks.js"></script>
                
                <script type="text/javascript" src="../js/lib/zig.js"></script>
                
                <script type="text/javascript" src="../js/kinect-decoder.js"></script>
                <script type="text/javascript" src="../js/image-handling.js"></script>
                <script type="text/javascript" src="../js/kinect-touch-controller.js"></script>
                
                <script type="text/javascript" src="../js/geometry.js"></script>
                
                <script>
                    // Camera constants
                    const VIEW_ANGLE = 45;
                    
                    const SCREEN_WIDTH = window.innerWidth;
                    const SCREEN_HEIGHT = window.innerHeight;
                    
                    const ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT;
                    const NEAR = 0.01;
                    const FAR = 200;
                    
                    var container, scene, camera, renderer, controls;
                    var mouseXOnMouseDown = 0;
                    var level;
                    
                    /**
                     Set up the scene
                     */
                    function init() {
                        
                        // Scene
                        scene = new THREE.Scene();
                        
                        // Level
                        blockTokens = [new KlotskiToken(0, 0, 2, 1),
                                       new KlotskiToken(2, 0, 2, 1),
                                       new KlotskiToken(0, 1, 2, 1),
                                       new KlotskiToken(0, 2, 2, 1),
                                       new KlotskiToken(2, 2, 2, 1),
                                       new KlotskiToken(0, 3, 1, 1),
                                       new KlotskiToken(1, 3, 1, 1),
                                       new KlotskiToken(0, 4, 1, 1),
                                       new KlotskiToken(1, 4, 1, 1),
                                       new KlotskiToken(2, 3, 2, 2, true) // Main block
                                       ];
                        
                        level = new KlotskiLevel(blockTokens);
                        scene.add(level);
                        
                        // Camera
                        camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
                        scene.add(camera);
                        camera.position.set(2, 2.5, 12);
                        
                        camera.lookAt(new THREE.Vector3(2, 2.5, 0));
                        
                        // Renderer
                        renderer = new THREE.WebGLRenderer({antialias: true});
                        renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
                        container = document.createElement('div');
                        document.body.appendChild(container);
                        container.appendChild(renderer.domElement);
                        
                        // Events -- Oy!!!! Make this work again later!
                        //THREEx.WindowResize(renderer, camera);
                        
                        // Start listening for mouse clicks
                        document.addEventListener('mousedown', mouseClick, false);
                        document.addEventListener('mousemove', mouseMove, false);
                        document.addEventListener('mouseup', mouseRelease, false);
                        
                        // Kinect
                        initKinect();
                        
                        // Start the update loop
                        tick();
                    }
                    
                    
                    /**
                     Update loop
                     */
                    function tick() {
                        requestAnimationFrame(tick);
                        renderer.render(scene, camera)
                        level.tick();
                    }
                    
                    
                    /**
                     Called when the player can't move any more blocks
                     */
                    function callback() {
                        console.log("End of turns!");
                    }
                    
                    
                    /*---------------
                     ===| Kinect |===
                     --------------*/
                    const KINECT_DEPTH_WIDTH = 160;
                    const KINECT_DEPTH_HEIGHT = 120;
                    
                    var plugin;
                    var depthData = new Array(KINECT_DEPTH_WIDTH * KINECT_DEPTH_HEIGHT);
                    
                    
                    /**
                     Start retrieving and processing Kinect data
                     */
                    function initKinect() {
                        plugin = document.getElementById("ZigPlugin");
                        
                        var depthRef = JSON.parse(localStorage.depthRef);
                        var tData = JSON.parse(localStorage.transform);
                        
                        // If no transform data is found, return.
                        if (!depthRef || !tData) return;
                        
                        var transform = new Geometry.Transform(tData[0], tData[1]);
                        kinectTouchController = new KinectTouchController(depthRef, transform);
                        // Set event callbacks
                        kinectTouchController.onClick = kinectClick;
                        kinectTouchController.onMove = kinectMove;
                        kinectTouchController.onRelease = kinectRelease;
                        
                        // Start the video streams
                        plugin.requestStreams({updateDepth:true, updateImage:true});
                        // Start updating the canvases every new kinect frame
                        plugin.addEventListener("NewFrame", updateKinectData);
                    }
                    
                    
                    /**
                     ...
                     */
                    function updateKinectData() {
                        /* Take a snapshot from the Kinect depth video */
                        KinectDecoder.decodeDepth(plugin.depthMap, depthData);
                        kinectTouchController.update(depthData);
                    }
                    
                    /*----------------------
                     ===| Kinect Events |===
                     ---------------------*/
                    /**
                     When the screen is clicked
                     */
                    function kinectClick(point) {
                        inputClick(point.x, point.y);
                    }
                    
                    
                    /**
                     Called whenever the screen is moved.
                     */
                    function kinectMove(point) {
                        inputMove(point.x, point.y);
                    }
                    
                    
                    /**
                     Called when the screen is released
                     */
                    function kinectRelease(point) {
                        console.log();
                        inputRelease(point.x, point.y);
                    }
                    
                    
                    /*---------------------
                     ===| Mouse Events |===
                     --------------------*/
                    /**
                     When the mouse is clicked
                     */
                    function mouseClick(event) {
                        inputClick(event.clientX, event.clientY);
                    }
                    
                    
                    /**
                     Called whenever the mouse is moved.
                     */
                    function mouseMove(event) {
                        inputMove(event.clientX, event.clientY);
                    }
                    
                    
                    /**
                     Called when the left mouse button is released
                     */
                    function mouseRelease(event) {
                        inputRelease(event.clientX, event.clientY);
                    }
                    
                    /*-----------------------------
                     ===| General Input Events |===
                     ----------------------------*/
                    /**
                     When the mouse is clicked
                     */
                    function inputClick(x, y) {
                        // event.preventDefault()
                        console.log("Clicked at (" + x + "), (" + y + ")");
                        level.clickEvent(x, y);
                    }
                    
                    
                    /**
                     Called whenever the mouse is moved.
                     */
                    function inputMove(x, y) {
                        level.moveEvent(x, y);
                    }
                    
                    
                    /**
                     Called when the left mouse button is released
                     */
                    function inputRelease(x, y) {
                        console.log("Released at (" + x + "), (" + y + ")");
                        level.releaseEvent();
                    }
                    
                    </script>
                </head>
    
    <body style="overflow:hidden; margin:0px" onload="init()">
        
        <div id="pluginContainer">
            <object id="ZigPlugin" type="application/x-zig" width="0" height="0">
                <param name="onload" value="zigPluginLoaded">
                    </object>
        </div>
        
    </body>
</html>

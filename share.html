
<!-- Partly based on example from http://learningwebgl.com/lessons/lesson02/index.html -->

<html>
    <head>
        
        <title>Point Cloud Rendering Test</title>
        
		<script type="text/javascript" src="js/tab-control.js"></script>
		<script type="text/javascript" src="js/popup-manager.js"></script>
		
        <script type="text/javascript" src="js/mediaext.js"></script>
        <script type="text/javascript" src="js/lib/webgl-utils.js"></script>
        <script type="text/javascript" src="js/lib/glMatrix-0.9.5.min.js"></script>
		<script type="text/javascript" src="js/model-controller.js"></script>
        <script type="text/javascript" src="js/point-cloud-renderer.js"></script>
		<script type="text/javascript" src="js/phong-renderer.js"></script>
		<script type="text/javascript" src="js/phong-renderer-ext.js"></script>
		<script type="text/javascript" src="js/rgba-mesh-renderer.js"></script>
		<script type="text/javascript" src="js/ply-parser.js"></script>
		
        <link rel="stylesheet" type="text/css" href="css/pb.css"/>
        <link rel="stylesheet" type="text/css" href="css/pointcloud.css"/>
		
        <script type="text/javascript">
			
			const kWidth = 640, kHeight = 480;
            
			var glCanvas,
				renderer = null,
				controller = null,
				model = null,
				shareButton,
				clearButton,
				sendRotTimer = null,
				resumeSend = false,
				invitePopup;
			
			TabControl.onLoad = function() {
                
				// Create the WebGL canvas
				glCanvas = MediaExt.createCanvas(kWidth, kHeight);
                glCanvas.style.display = "none";
                glCanvas.style.margin = "20px auto";
                document.getElementById("container").appendChild(glCanvas);
				
				// Create a controller for the models
				controller = new ModelController(glCanvas);
				
				// Initialize the control panel for material properties
				document.getElementById("specularColor").onchange = function() {
					crapHexToRGB(this.value, specular);
					updateInputs("specular", specular);
				}
				document.getElementById("diffuseColor").onchange = function() {
					crapHexToRGB(this.value, diffuse);
					updateInputs("diffuse", diffuse);
				}
				document.getElementById("ambientColor").onchange = function() {
					crapHexToRGB(this.value, ambient);
					updateInputs("ambient", ambient);
				}
				document.getElementById("shininess").value = shininess;
				
				updateInputs("specular", specular);
				updateInputs("diffuse", diffuse);
				updateInputs("ambient", ambient);
				
				shareButton = document.getElementById("shareButton");
				clearButton = document.getElementById("clearButton");
				
				// **********************
                // Drag and drop with File API
                var dropbox = document.getElementById("dropbox"),
					state = document.getElementById("status");
                
                if (typeof window.FileReader === "undefined") {
                    state.className = "fail";
                    state.innerHTML = "File API unavailable, change browser!!!! :)";
                } else {
                    state.className = "success";
                }
                
                dropbox.ondragenter = function () { dropbox.className = "hover"; return false; };
                dropbox.ondragleave = function () { dropbox.className = ""; return false; };
                dropbox.ondragover = function () { dropbox.className = "hover"; return false; };
                dropbox.ondragend = function () { return false; };
                dropbox.ondrop = function (e) {
                    dropbox.className = "";
                    e.preventDefault();
                    readFiles(e.dataTransfer.files);
                    return false;
                };
                // **********************
                
                document.getElementById("fileSelect").addEventListener("change",
																	   function () { readFiles(this.files); },
																	   false);
				
				invitePopup = PopupManager.createPopup("Someone wants to share a 3D model with you!",
													   "images/share-icon.png",
													   {text:"Accept", func:acceptShared3DModel},
													   {text:"Decline", func:declineShared3DModel});
            }
			
			TabControl.onActivate = function() {
				requestAnimFrame(drawScene);
				
				if (resumeSend) {
					sendRotation();
				}
			}
			
			TabControl.onDeactivate = function() {
				cancelAnimFrame(drawScene);
				if (sendRotTimer) {
					clearTimeout(sendRotTimer);
					resumeSend = true;
					sendRotTimer = null;
				}
			}
			
			TabControl.onStreamAdded = function(stream) {};
			TabControl.onStreamRemoved = function(stream) {};
			
			TabControl.onMessageReceived = function(senderId, type, data) {
				
				switch (type) {
					case "rotate":
						controller.updateRotation(data.rot);
						break;
					case "invite":
						PopupManager.showPopup(invitePopup);
						break;
					case "inviteAccepted":
						onShareAccepted();
						break;
					case "inviteDeclined":
						onShareDeclined();
						break;
					case "model":
						displayModel(data);
						sendRotation();
						TabControl.sendMessage("share", "modelReceived", {});
						break;
					case "modelReceived":
						console.log("Received model load confirmation");
						sendRotation();
						break;
				}
			}
			
			TabControl.onKinectInit = function(proxy) {};
			TabControl.onNewKinectData = function(videoData, depthData) {};
			
			function updateInputs(name, values) {
				document.getElementById(name + "Color").value = crapRGBtoHex(values);
				document.getElementById(name + "0").value = values[0] * 255;
				document.getElementById(name + "1").value = values[1] * 255;
				document.getElementById(name + "2").value = values[2] * 255;
			}
            
			function sendShareInvite() {
				TabControl.sendMessage("share", "invite", {/*thumbnail of the 3D model, name of the file, ...*/});
				shareButton.disabled = true;
			}
			
			function onShareAccepted() {
				if (model) {
					console.log("Sending model");
					console.log(model);
					
					// Send the model
					TabControl.sendMessage("share", "model", serializeModel(model));
					
					console.log("Waiting for confirmation...");
				}
			}
			
			function onShareDeclined() {
				// TODO: display message
				clearTimeout(sendRotTimer);
				sendRotTimer = null;
				shareButton.disabled = false;
			}
			
			function acceptShared3DModel() {
				// TODO: switchToTab("#share");
				TabControl.sendMessage("share", "inviteAccepted", {});
			}
			
			function declineShared3DModel() {
				TabControl.sendMessage("share", "inviteDeclined", {});
			}
			
			
            function readFiles(files) {
                
                var file = files[0];
                
                var splitName = file.name.split(".");
                if (splitName.length < 2 || splitName[1] !== "ply") {
                    alert("I ONLY ACCEPT .ply FILES! ." + splitName[1] + " FILES ANGER ME! >:(");
                    return;
                }
                
                var progress = document.getElementById("percentBar"),
					dropbox = document.getElementById("dropbox"),
					reader = new FileReader();
				
                reader.onerror = function(evt) {
					var error = evt.target.error;
					switch (error.code) {
						case error.NOT_FOUND_ERR:
							alert("File Not Found!");
							break;
						case error.NOT_READABLE_ERR:
							alert("File is not readable");
							break;
						case error.ABORT_ERR:
							break;
						default:
							alert("An error occurred reading this file.");
							break;
					};
				};
				
                reader.onprogress = function(evt) {
					// evt is an ProgressEvent.
					if (evt.lengthComputable) {
						var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
						// Increase the progress bar length.
						if (percentLoaded < 100) {
							progress.style.width = percentLoaded + "%";
							progress.textContent = percentLoaded + "%";
						}
					}
				};
                
				reader.onabort = function(e) {
                    alert("File read cancelled");
                };
                
				reader.onloadstart = function(e) {
                    document.getElementById("progressBar").className = "loading";
                };
                
				reader.onload = function (event) {
                    // Ensure that the progress bar displays 100% at the end.
                    progress.style.width = "100%";
                    progress.textContent = "100%";
                    
					var result;
					
					try {
						result = Ply.parse(event.target.result);
						console.log(result);
					} catch (error) {
						alert("Error parsing model. " + error);
						return;
					}
					
					setTimeout(function() {
								document.getElementById("progressBar").className = "";
								displayModel(result);
							   }, 0);
                };
				
                console.log('Reading file:');
                console.log(file);
				reader.readAsArrayBuffer(file); // .readAsDataURL.readAsText
            }
			
			var specular = [0.8, 0.8, 0.8],
				diffuse = [0.6, 0.6, 0.6],
				ambient = [0.2, 0.2, 0.2],
				shininess = 20.0,
				lightPos = [0, 0, 0],
				zoom = 1.0;
			
			function serializeModel(aModel) {
				
				var result = {};

				var copyArray = function(src) {
					if (typeof src == "Array") {
						return src;
					}
					if (src && src.length) {
						var len = src.length;
						var cpy = new Array(len);
						for (var i = 0; i < len; ++i) {
							cpy[i] = src[i];
						}
						return cpy;
					}
					// return undefined;
				}
				
				result.pos = copyArray(aModel.pos);
				result.normals = copyArray(aModel.normals);
				result.colors = copyArray(aModel.colors);
				result.faces = copyArray(aModel.faces);
				
				return result;
			}
			
			function displayModel(aModel) {
				
				clearGLCanvas();
				
				// Select renderer
				if (aModel.pos) {
					if (!aModel.faces) {
						// No faces means it's a point cloud
						if (aModel.colors) {
							renderer = new PointCloudRenderer(glCanvas);
							renderer.bufferData(aModel.pos, aModel.colors);
						}
					} else {
						if (aModel.normals) {
							renderer = new PhongRendererExt(glCanvas);
							renderer.bufferData(aModel.pos, aModel.normals, aModel.faces);
						} else if (aModel.colors) {
							renderer = new MeshRenderer(glCanvas);
							renderer.bufferData(aModel.pos, aModel.colors, aModel.faces);
						}
					}
					
					controller.calculateInitalTransform(aModel.pos);
				}
				
				if (renderer) {
					
					model = aModel;
					
					dropbox.style.display = "none";
					glCanvas.style.display = "block";
					shareButton.disabled = false;
					clearButton.disabled = false;
				
				} else {
					// No suitable renderer found, alert?
				}
			}
			
			function drawScene() {
				
				requestAnimFrame(drawScene);
				
				if (renderer) {
					
					if (renderer.setSpecular) {
						renderer.setSpecular(specular);
						renderer.setDiffuse(diffuse);
						renderer.setAmbient(ambient);
						renderer.setShininess(shininess);
						renderer.setLightPos(lightPos);
						renderer.setZoom(zoom);
					}
					
					var mvMatrix = controller.getModelViewMatrix();
					renderer.setModelViewMatrix(mvMatrix);
					renderer.render();
				}
			}
            
			function sendRotation() {
				var sendRot = controller.getSendRotation();
				if (sendRot) {
					TabControl.sendMessage("share", "rotate", {rot:sendRot});
				}
				setTimeout(sendRotation, 100);
			}
			
			function clearGLCanvas() {
				
				if (renderer) {
					// Destroy the renderer
					renderer.destroy();
					renderer = null;
					model = null;
				}
				
				// Setting width and height clears the canvas
				glCanvas.width = glCanvas.width;
				glCanvas.height = glCanvas.height;
				
				dropbox.style.display = "block";
				glCanvas.style.display = "none";
				
				clearButton.disabled = true;
				shareButton.disabled = true;
			}
			
			
			var haxHex = "0123456789abcdef";
			
			function crapHexToRGB(value, dst) {
				
				var R = ((haxHex.indexOf(value[1])) << 4 | haxHex.indexOf(value[2])) / 255.0;
				var G = ((haxHex.indexOf(value[3])) << 4 | haxHex.indexOf(value[4])) / 255.0;
				var B = ((haxHex.indexOf(value[5])) << 4 | haxHex.indexOf(value[6])) / 255.0;
				
				if (!dst) {
					dst = [];
				}
				
				dst[0] = R;
				dst[1] = G;
				dst[2] = B;
				
				return dst;
			}
			
			function crapRGBtoHex(rgb) {
				const maskUpper = 240; // 0xf0
				const maskLower = 15; // 0x0f
				var R = Math.round(rgb[0] * 255);
				var G = Math.round(rgb[1] * 255);
				var B = Math.round(rgb[2] * 255);
				
				var hex = "#" + haxHex[(R & maskUpper) >> 4] + haxHex[R & maskLower] +
								haxHex[(G & maskUpper) >> 4] + haxHex[G & maskLower] +
								haxHex[(B & maskUpper) >> 4] + haxHex[B & maskLower];
				return hex;
			}
			
            </script>
        
    </head>
	
	<body>
        
        <h1>Share 3D models</h1>
		
		<div id="controls" style="padding:0px 20px 20px 20px; border:1px solid black; border-radius:5px; position:absolute; left:20px; top:60px;">
			
			<h2>Material</h2>
			<h3>Specular <input id="specularColor" type="color"/></h3>
			<div style="text-align:right;">
				Red <input id="specular0" type="range" min=0 max=255 value=127
				onchange="specular[0] = Number(this.value / 255.0); updateInputs('specular', specular);"/><br>
				Green <input id="specular1" type="range" min=0 max=255 value=127
				onchange="specular[1] = Number(this.value / 255.0); updateInputs('specular', specular);"/><br>
				Blue <input id="specular2" type="range" min=0 max=255 value=127
				onchange="specular[2] = Number(this.value / 255.0); updateInputs('specular', specular);"/><br>
			</div>
			
			<h3>Diffuse <input id="diffuseColor" type="color"/></h3>
			<div style="text-align:right;">
				Red <input id="diffuse0" type="range" min=0 max=255 value=127
				onchange="diffuse[0] = Number(this.value / 255.0); updateInputs('diffuse', diffuse);"/><br>
				Green <input id="diffuse1" type="range" min=0 max=255 value=127
				onchange="diffuse[1] = Number(this.value / 255.0); updateInputs('diffuse', diffuse);"/><br>
				Blue <input id="diffuse2" type="range" min=0 max=255 value=127
				onchange="diffuse[2] = Number(this.value / 255.0); updateInputs('diffuse', diffuse);"/><br>
			</div>
			
			<h3>Ambient <input id="ambientColor" type="color"/></h3>
			<div style="text-align:right;">
				Red <input id="ambient0" type="range" min=0 max=255 value=127
				onchange="ambient[0] = Number(this.value / 255.0); updateInputs('ambient', ambient);"/><br>
				Green <input id="ambient1" type="range" min=0 max=255 value=127
				onchange="ambient[1] = Number(this.value / 255.0); updateInputs('ambient', ambient);"/><br>
				Blue <input id="ambient2" type="range" min=0 max=255 value=127
				onchange="ambient[2] = Number(this.value / 255.0); updateInputs('ambient', ambient);"/><br>
			</div>
			
			<h3>Shininess</h3>
			<div style="text-align:right;">
				<input id="shininess" type="range" min=0 max=255 value=127
				onchange="shininess = Number(this.value);"/><br>
			</div>
			
			<h3>Zoom</h3>
			<div style="text-align:right;">
				<input type="range" min=0 max=2 value=1 step=0.01
				onchange="zoom = Number(this.value);"/><br>
			</div>
		</div>

		<div id="controls" style="padding:0px 20px 20px 20px; border:1px solid black; border-radius:5px; position:absolute; right:20px; bottom:60px;">
			
			<h2>Light</h2>
			<h3>Position</h3>
			<div style="text-align:right;">
				x <input type="range" min=-5 max=5 value=0 step=0.05
				onchange="lightPos[0] = Number(this.value);"/><br>
				y <input type="range" min=-5 max=5 value=0 step=0.05
				onchange="lightPos[1] = Number(this.value);"/><br>
				z <input type="range" min=-5 max=5 value=0 step=0.05
				onchange="lightPos[2] = Number(this.value);"/><br>
				
				BLOB! <input type="range" min=-0.125 max=0.125 value=0 step=0.00125
				onchange="renderer.setBlobbiness(this.value);"/><br>
			</div>
			
		</div>

        <div id="container">
            <div id="dropbox">
                <p id="status">Drop a .ply file here, or use this fine button:<br><br><input type="file" id="fileSelect"></p>
                <div id="progressBar">
                    <div id="percentBar">0%</div>
                </div>
            </div>
        </div>
		
		<button id="shareButton" onclick="sendShareInvite();"
			style="padding:1em; margin:0em;" disabled=true>Share!</button>
		<button id="clearButton" onclick="clearGLCanvas();"
			style="padding:1em; margin:0em;" disabled=true>Clear</button>
	
	</body>
    
</html>
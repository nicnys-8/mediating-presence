<!--
 Accesses the Kinect RGB and depth video streams.
 -->

<!DOCTYPE html>
<html>
    <head>
        <title>Kinect camera access test</title>
        
        <script src="../lib/zig.js"></script>
        <script src="../lib/kinectVideoDecoder.js"></script>
        
        <script>
            
            function init() {
                
                var rgbCanvas = document.getElementById("rgbCanvas");
                var rgbContext = rgbCanvas.getContext("2d");
                
                var depthCanvas = document.getElementById("depthCanvas");
                var depthContext = depthCanvas.getContext("2d");
                
                var firstEvent = false;
                zig.embed();
                
                var plugin = document.getElementById("ZigPlugin"); // the <object> element
                
                plugin.requestStreams({updateDepth:true, updateImage:true});
                
                plugin.addEventListener("NewFrame", function() { // triggered every new kinect frame
                                        var temp = rgbContext.createImageData(rgbCanvas.width, rgbCanvas.height);
                                        
                                        // Draw the rgb image
                                        var rgbImage = kinectVideoDecoder.decodeRGB(plugin.imageMap);
                                        
                                        for (var i = 0; i < rgbImage.length; i++) {
                                        temp.data[i] = rgbImage[i];
                                        }
                                        rgbContext.putImageData(temp, 0, 0);
                                        
                                        // Draw the depth image
                                        var depthImage = kinectVideoDecoder.decodeDepth(plugin.depthMap);
                                        var index = 0;
                                        
                                        var depthValue;
                                        for (var i = 0; i < depthImage.length; i+=2) {
                                        
                                        depthValue = depthImage[i] | (depthImage[i + 1] << 8);
                                        depthValue = depthValue / 2047;
                                        depthValue = depthValue * 255;
                                        
                                        temp.data[index++] = depthValue;
                                        temp.data[index++] = 0;
                                        temp.data[index++] = 0;
                                        temp.data[index++] = 255;
                                        }
                                        
                                        depthContext.putImageData(temp, 0, 0);
                                        });
            }
            </script>
    </head>
    <body onload="init();">
        
        <div id="pluginContainer">
            <object id="ZigPlugin" type="application/x-zig" width="0" height="0">
                <param name="onload" value="zigPluginLoaded">
                    </object>
        </div>
        
        <div style="position: relative;">
            <canvas id="rgbCanvas" width="160" height="120"
                style="position: relative; left: 0; top: 0; z-index: 0;">
            </canvas>
            
            <canvas id="depthCanvas" width="160" height="120"
                style="position: relative; left: 200; top: 130; z-index: 0;">
            </canvas>
            
        </div>
        
    </body>
</html>
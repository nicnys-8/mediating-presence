<html>
    <head>
        
        <title>New thing</title>
        
        <h1>Welcome to the lobby!</h1>
        
        <link rel="stylesheet" type="text/css" href="css/pb.css"/>
        <style type="text/css">
            
            h1 {
                top: 10px;
            }
            
			body {
				background:url('images/paper.jpg');
                text-align: center;
			}
            
            #roomCreation {
                padding: 10px;
            }
            
            #roomTable {
                margin: 0 auto;
            }
            
            form {
                font-size: 20px;
                display:inline;
            }
            
            table-cell {
                font-size: 200px;
            }
            
            button {
                display:inline;
            }
            
            </style>
        
        <script src="http://ec2-54-228-160-5.eu-west-1.compute.amazonaws.com:3005/socket.io/socket.io.js"></script>
        <script src="js/lib/jquery.js"></script>
		<script src="js/lynckia-client.js"></script>
		<script>
            var rooms;
            var roomDictionary = {};
            var roomTable;
            
            /**
             Called when the body loads
             */
            var load = function() {
                
                // var socket = io.connect("http://localhost:3005");
                var socket = io.connect("ec2-54-228-160-5.eu-west-1.compute.amazonaws.com:3005");
                
                socket.on("roomAdded",
                          /**
                           Decription goes here
                           */
                          function (data) {
                          var room = data.room;
                          console.log("Broadcast message received from server: Room with name " + room.name + " has been added");
                          // If the room isn't already displayed, display it
                          if (!roomDictionary[room._id]) addRoomInfo(room);
                          });
                
                socket.on("roomDeleted",
                          /**
                           Decription goes here
                           */
                          function (data) {
                          console.log("Broadcast message received from server: Room with ID " + data.roomId + " has been deleted");
                          removeRoomInfo(data.roomId);
                          });
                
                roomTable = document.getElementById("roomTable");
                
                // Ask for a list of all rooms
                getRooms(onGotRooms);
                // Ask for new the room list every two seconds, just to be safe...
                //setInterval(updateRoomList, 10000);
            };
            
            /**
             Asks the server for a list of all rooms, setting the callback function
             for when they are received
             */
            var updateRoomList = function() {
                getRooms(onGotRooms);
            };
            
            
            /**
             Displays all rooms returned from the server
             */
            var onGotRooms = function(roomList) {
                rooms = JSON.parse(roomList);
                for (var i = 0; i < rooms.length; i++) {
                    var room = rooms[i];
                    // If the room doesn't already exists, add it
                    if (!roomDictionary[room._id]) addRoomInfo(room);
                }
            };
            
            /**
             Display information and buttons describing the specified room
             */
            var addRoomInfo = function(room) {
                
                var row = document.createElement("tr");
                row.style.backgroundColor = "blue";
                roomTable.appendChild(row)
                
                var nameCell = document.createElement("td");
                var joinCell = document.createElement("td");
                var deleteCell = document.createElement("td");
                
                row.appendChild(nameCell);
                row.appendChild(joinCell);
                row.appendChild(deleteCell);
                
                // Display the name of the room
                nameCell.innerHTML = room.name;
                
                // Add the div to the dictionary
                roomDictionary[room._id] = row;
                
                // Add the button for joining a room
                var joinButton = document.createElement("button");
                joinButton.innerHTML = "Join";
                // Make the button send the user to the main page,
                // with the room ID passed as a URL argument
                joinButton.onclick = function() {
                    window.location.href = "/room.html?" + room._id;
                }
                joinCell.appendChild(joinButton);
                
                // Add the button for deleting a room
                var deleteButton = document.createElement("button");
                deleteButton.innerHTML = "Delete";
                // Definition of the function for handling room deletion
                deleteButton.onclick = function() {
                    // If the rooms exists:
                    if (roomDictionary[room._id]) {
                        // (deleteRoom is defined in lynckia-client.js)
                        console.log("Delete room button clicked");
                        deleteRoom(room.name);
                    } else {
                        console.log("Attempting to delete nontexistent room");
                    }
                }
                deleteCell.appendChild(deleteButton);
            };
            
            /**
             Remove the displayed room information
             */
            var removeRoomInfo = function(roomId) {
                if (roomDictionary[roomId]) {
                    roomTable.removeChild(roomDictionary[roomId]);
                    delete roomDictionary[roomId];
                }
            };
            
            /**
             Sends a request to the server to create a new room
             */
            var createRoomButtonClicked = function() {
                console.log("Create room button pressed");
                var roomName = document.getElementById("roomName").value;
                createRoom(roomName); // second argument is the callback function
            };
            
            /**
             Make the text input react to the enter key
             */
            function handleKeyPress(event){
                var key = event.keyCode || event.which;
                if (key == 13){
                    createRoomButtonClicked();
                }
            }
            
			</script>
    </head>
	
	<body onload="load()">
        
        <a href="http://www.ltu.se" target="_blank"><img src="images/ltu_logo_small.png" style="position:absolute; left:5px; top:5px;">
            </a>
        <a href="http://www.ltu.se" target="_blank"><img src="images/ltu_logo_small.png" style="position:absolute; right:5px; top:5px;">
            </a>
        
        <div id="roomCreation">
            Write a room name:
            <input id="roomName" type="text" rows="1" cols="20" onkeypress="handleKeyPress(event)"></input>
            
            <button id="createRoomBtn" onclick="createRoomButtonClicked()">
                Create room
            </button>
        </div>
        
        <table id="roomTable"></table>
    </body>
</html>



<!-- :hover doesn't work with the doctype tag..?
<!DOCTYPE html>
-->

<html>
    <head>
        
        <title>Hello chat</title>
		
        <style type="text/css">
			
			* {
				margin:0;
				padding:0;
			}
			
			html, body {
				height:100%;
				width:100%;
			}
			
			body {
				background:url('images/paper.jpg');
				/*background:url('images/paper-tile.png');*/
			}
			
			iframe {
				display:none;
				overflow:auto;
				position:absolute;
				width:100%;
				height:100%;
				left:-100%;
			}
			
			#wrap {
				position:absolute;
				top:100px;
				bottom:0px;
				left:0px;
				right:0px;
			}
			
			#menu {
				width:500px;
				height:100px;
				margin:0 auto 0 auto;
				clear:both;
			}
			
			#menu ul {
				list-style:none;
			}
			#menu ul li {
				display:inline;
			}
			
			#sidebar-left {
				position:absolute;
				left:0px;
				width:100px;
				height:100%;
				background-color:lightblue;
				z-index:2;
			}
			#sidebar-right {
				position:absolute;
				right:0px;
				width:100px;
				height:100%;
				background-color:lightblue;
				z-index:2;
			}
			#content {
				position:absolute;
				left:0px; /*100px;*/
				right:0px; /*100px;*/
				height:100%;
				z-index:1;
			}
			.linkbutton {
				display:inline-block;
				width:100px;
				height:100px;
				background-position:0 0;
				background-size:400%;
			}
			
			.linkbutton.selected,
			.linkbutton.selected:hover {
				background-position:66.6666666% 0;
			}
			.linkbutton.disabled,
			.linkbutton.disabled:hover,
			.linkbutton.disabled:active {
				background-position:100% 0;
			}
			
			.linkbutton:hover {
				background-position:33.3333333% 0;
			}
			.linkbutton:active {
				background-position:66.6666666% 0;
			}
			
			#chatbutton {
				background-image:url('images/chat-top.png');
			}
			
			#sharebutton {
				background-image:url('images/share-top.png');
			}
			
			#playbutton {
				background-image:url('images/play-top.png');
			}
			
			#audiobutton {
				background-image:url('images/audio-top.png');
			}
			
			#videobutton {
				background-image:url('images/video-top.png');
			}
			
		</style>
		
		<script type="text/javascript" src="js/lib/jquery.js"></script>
		<script type="text/javascript" src="js/tab-control.js"></script>
		<script type="text/javascript" src="js/kinect-decoder.js"></script>
		<script type="text/javascript" src="js/kinect-plugin-proxy-zigfu.js"></script>
		<script type="text/javascript" src="js/lib/erizo.js"></script>
		<script type="text/javascript" src="js/lynckia-client.js"></script>

		<script>
			
			var currentTabID;
			var enableVideo = true;
			var enableAudio = true;
			
			var tabOrder = [ "#chat", "#share", "#play" ];
			var tabControllers = {};
			
			TabControl.onActivate = function() {
			};
			TabControl.onDeactivate = function() {
			};
			
			TabControl.onLocalStreamInit = function(stream) {
				for (var tabName in tabControllers) {
					if (tabControllers[tabName]) {
						tabControllers[tabName].setLocalStream(stream);
					}
				}
			}

			TabControl.onStreamAdded = function(stream) {
			
				// Just propagate the message to the tabs
				for (var tabName in tabControllers) {
					if (tabControllers[tabName]) {
						tabControllers[tabName].onStreamAdded(stream);
					}
				}
			};
			
			TabControl.onStreamRemoved = function(stream) {
				
				// Just propagate the message to the tabs
				for (var tabName in tabControllers) {
					if (tabControllers[tabName]) {
						tabControllers[tabName].onStreamRemoved(stream);
					}
				}
			};
			
			TabControl.onMessageReceived = function(senderId, type, packet) {
				
				console.log("Received messsage");
				console.log(packet);

				var destinationTab = packet.dst;
				var messageType = packet.type;
				var data = packet.data;

				if (destinationTab == "all") {
					
					for (var tabName in tabControllers) {
						if (tabControllers[tabName]) {
							tabControllers[tabName].onMessageReceived(senderId, messageType, data);
						}
					}
					
				} else {
					
					var tabController = tabControllers[destinationTab] || tabControllers["#" + destinationTab];
					if (tabController) {
						tabController.onMessageReceived(senderId, messageType, data);
					}
				}
			};

			TabControl.onKinectInit = function(proxy) {

				// Important! This needs to happen after TabControl.onLoad
				// TODO: Make sure it does! :)
				
				for (var tabName in tabControllers) {
					if (tabControllers[tabName]) {
						tabControllers[tabName].onKinectInit(proxy);
					}
				}
			};
			
			TabControl.onNewKinectData = function(videoData, depthData) {
				for (var tabName in tabControllers) {
					if (tabControllers[tabName]) {
						tabControllers[tabName].onNewKinectData(videoData, depthData);
					}
				}
			};
			
            TabControl.onLoad = function() {
				
				initLynckia(TabControl);

				currentTabID = "#chat";
				
				// If a tab is specified in the url, make it the current tab
				var hash = window.location.hash;
				hash = hash.substring(0, hash.length - 1); // remove underscore
				
				if (tabOrder.indexOf(hash) != -1) {
					currentTabID = hash;
				}
				
				var currentTab = $(currentTabID);
				
				currentTab.show();
				currentTab.css("left", "0");
				$(currentTabID + "button").addClass("selected");
				
				var tabs = $("iframe");
				
				tabs.each(function() {
							tabControllers["#" + this.id] = this.contentWindow.TabControl;
							deactivateTab(this.id);
						  });
				
				activateTab(currentTabID);
			};
			
			function activateTab(tabName) {
				
				var tabController = tabControllers[tabName] || tabControllers["#" + tabName];
				
				if (tabController && tabController.onActivate) {
					tabController.onActivate();
				} else {
					console.warn("Failed to activate tab '" + tabName + "', since it has no TabControl object. Please import the script 'tab-control.js'!");
				}
			}
			
			function deactivateTab(tabName) {
				
				var tabController = tabControllers[tabName] || tabControllers["#" + tabName];
				
				if (tabController && tabController.onDeactivate) {
					tabController.onDeactivate();
				} else {
					console.warn("Failed to deactivate tab '" + tabName + "', since it has no TabControl object. Please import the script 'tab-control.js'!");
				}
			}
			
			function switchToTab(nextTabID) {
				
				if (nextTabID == currentTabID) {
					return;
				}
				
				var currentTab = $(currentTabID);
				var nextTab = $(nextTabID);
				
				// Choose animation direction depending on if the next tab is
				// to the left or to the right of the current tab
				var fromLeft = tabOrder.indexOf(currentTabID) > tabOrder.indexOf(nextTabID);
				var startPos = fromLeft ? "-100%" : "100%";
				
				deactivateTab(currentTabID);
				currentTab.animate({
									left:"-=" + startPos,
									opacity:0.0,
									}, 500, function() {
										// Animation complete.
										$(this).hide();
									});

				nextTab.show();
				nextTab.css("left", startPos);
				nextTab.css("opacity", 0.0);
				nextTab.animate({
								 left:"-=" + startPos,
								 opacity:1.0,
								 }, 500, function() {
									activateTab(this.id);
								 });
				
				$(currentTabID + "button").toggleClass("selected");
				$(nextTabID +"button").toggleClass("selected");
				
				currentTabID = nextTabID;
				window.location.hash = nextTabID + "_";
			}
			
			function toggleAudio() {
				
				var audiobutton = $("#audiobutton");
				if (audiobutton.hasClass("disabled"))
					return;
				
				audiobutton.css("background-image", enableAudio ? "url('images/noaudio-top.png')" : "url('images/audio-top.png')");

				enableAudio = !enableAudio;
			}
			
			function toggleVideo() {
				
				var videobutton = $("#videobutton");
				if (videobutton.hasClass("disabled"))
					return;
				
				videobutton.css("background-image", enableVideo ? "url('images/novideo-top.png')" : "url('images/video-top.png')");
				
				enableVideo = !enableVideo;
			}
			
		</script>
        
    </head>
	
	<body>
		
		<div id="pluginContainer">
			<object id="ZigPlugin" type="application/x-zig" width="0" height="0">
				<param name="onload" value="zigPluginLoaded">
					</object>
		</div>
		
		<div id="menu"><!-- These comments are only here to avoid whitespace between the divs :)
			--><ul><!--
				--><li><div class="linkbutton" id="chatbutton"
					onclick="switchToTab('#chat');"></div></li><!--
				--><li><div class="linkbutton" id="sharebutton"
					onclick="switchToTab('#share');"></div></li><!--
				--><li><div class="linkbutton" id="playbutton"
					onclick="switchToTab('#play');"></div></li><!--
				--><li><div class="linkbutton" id="audiobutton"
					onclick="toggleAudio();"></div></li><!--
				--><li><div class="linkbutton disabled" id="videobutton"
					onclick="toggleVideo();"></div></li><!--
			--></ul><!--
		--></div>
		
		<div id="wrap">
			
			<!--
			<div id="sidebar-left">
			</div>
			-->
			
			<div id="content">
				
				<iframe id="chat" src="chat.html" seamless>GAH!</iframe>
				<iframe id="share" src="share.html" seamless>GAH!</iframe>
				<iframe id="play" src="play.html" seamless>GAH!</iframe>
				 
			</div>
			
			<!--
			<div id="sidebar-right">
			</div>
			-->
		</div>
    </body>
	
</html>


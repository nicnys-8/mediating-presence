
<html>
    <head>
        
        <title>Conway's Game of Life</title>
        
		<script type="text/javascript" src="js/webgl-utils.js"></script>
        <script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>
        
        <link rel="stylesheet" type="text/css" href="css/pb.css"/>
        <link rel="stylesheet" type="text/css" href="css/pointcloud.css"/>
        
        <script type="text/javascript">
			
			var WIDTH = 512, HEIGHT = 512;
			var drawCanvas, glCanvas, gl, prog, bufferIndex = 0, textures, frameBuffers, isRendering = false;
			
			function swap() {
				
				var button = document.getElementById("butt");
				
				if (isRendering) {
					drawCanvas.style.display = "inline";
					glCanvas.style.display = "none";
					cancelAnimFrame(draw); // Doesn't work, why?
					
					button.innerHTML = "Start";
				} else {
					drawCanvas.style.display = "none";
					glCanvas.style.display = "inline";
					
					gl.bindTexture(gl.TEXTURE_2D, textures[bufferIndex]);
					gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, drawCanvas);
					requestAnimFrame(draw);
					
					button.innerHTML = "Stop";
				}
				isRendering = !isRendering;
			}
			
			function clearCanvas() {
				drawCanvas.getContext("2d").clearRect(0, 0, WIDTH, HEIGHT);
				if (isRendering) {
					swap();
				}
			}
			
			function init() {
				
				drawCanvas = document.getElementById("drawCanvas");
				drawCanvas.width = WIDTH;
				drawCanvas.height = HEIGHT;
				drawCanvas.style.display = "inline";
				
				glCanvas = document.getElementById("glCanvas");
				glCanvas.width = WIDTH;
				glCanvas.height = HEIGHT;
				glCanvas.style.display = "none";
				
				drawCanvas.style.backgroundColor = "black";
				
				var image = new Image();
				image.onload = function() {
					drawCanvas.getContext("2d").drawImage(image, 256 - image.width / 2, 256 - image.height / 2);
				}
				image.src = "images/davegreenp59gun.png"; // "spaceship.png";
				
				var clicked = false;
				var ctx = drawCanvas.getContext("2d");
				
				ctx.fillStyle = "#FF0000";
				ctx.strokeStyle = "#FF0000";
				ctx.lineWidth = 1;
				
				// Simple drawing with mouse events
				
				drawCanvas.onmousedown = function(e) {
					var mouseX = Math.round(e.pageX - drawCanvas.offsetLeft - 0.5),
						mouseY = Math.round(e.pageY - drawCanvas.offsetTop - 0.5);
					clicked = true;
					ctx.fillRect(mouseX, mouseY, 1, 1);
					ctx.beginPath();
					ctx.moveTo(mouseX, mouseY);
					e.preventDefault();
				}
				
				drawCanvas.onmousemove = function(e) {
					if (clicked) {
						var mouseX = Math.round(e.pageX - drawCanvas.offsetLeft - 0.5),
							mouseY = Math.round(e.pageY - drawCanvas.offsetTop - 0.5);
						
						ctx.lineTo(mouseX, mouseY);
						ctx.stroke();
					}
					e.preventDefault();
				}
				drawCanvas.onmouseup = function(e) {
					var mouseX = Math.round(e.pageX - drawCanvas.offsetLeft - 0.5),
						mouseY = Math.round(e.pageY - drawCanvas.offsetTop - 0.5);
					clicked = false;
					e.preventDefault();
				}
				
				drawCanvas.onclick = function(e) {
					var mouseX = e.pageX - drawCanvas.offsetLeft,
						mouseY = e.pageY - drawCanvas.offsetTop;
					ctx.fillRect(mouseX, mouseY, 1, 1);
				}
				
				initGL();
			}
			
			function initGL() {
				
				// Create a WebGL context
				gl = WebGLUtils.setupWebGL2D(glCanvas);
				
				// Vertex shader
				var vsStr = [
							 "precision mediump float;",
							 "attribute vec3 position;",
							 "attribute vec2 texCoord;",
							 "varying vec2 uv;",
							 
							 "void main(void) {",
							 "gl_Position = vec4(position, 1.0);",
							 "uv = texCoord;",
							 "}"
							 ].join("\n");
				
				// Fragment shader
				var fsStr = [
							 "precision mediump float;",
							 "uniform sampler2D tex;",
							 "varying vec2 uv;",
							 
							 "void main(void) {",
							 "float onePixel = 1.0 / 512.0;",
							 "float red = 0.0;",
							 "float sum = 0.0;",
							 
							 // Sum the values of surrounding pixels
							 "sum += texture2D(tex, uv + onePixel * vec2(-1, -1)).r;",
							 "sum += texture2D(tex, uv + onePixel * vec2(-1, 0)).r;",
							 "sum += texture2D(tex, uv + onePixel * vec2(-1, 1)).r;",
							 "sum += texture2D(tex, uv + onePixel * vec2(0, -1)).r;",
							 "sum += texture2D(tex, uv + onePixel * vec2(0, 1)).r;",
							 "sum += texture2D(tex, uv + onePixel * vec2(1, -1)).r;",
							 "sum += texture2D(tex, uv + onePixel * vec2(1, 0)).r;",
							 "sum += texture2D(tex, uv + onePixel * vec2(1, 1)).r;",
							 
							 "if (sum < 2.0) {",
							 "red = 0.0;",
							 "} else if (sum < 3.0) {",
							 "red = texture2D(tex, uv).r;",
							 "} else if (sum == 3.0) {",
							 "red = 1.0;",
							 "} else {",
							 "red = 0.0;",
							 "}",
							 
							 "gl_FragColor = vec4(red, 0.0, 0.0, 1.0);",
							 "}",
							 ].join("\n");
				
				// Create the shader program
				prog = WebGLUtils.createProgram(gl, vsStr, fsStr);
				
				// Store the attribute and uniform locations as properties of the program
				prog.attrLocPosition = gl.getAttribLocation(prog, 'position');
				prog.attrLocTexCoord = gl.getAttribLocation(prog, 'texCoord');
				prog.unifLocTex = gl.getUniformLocation(prog, 'tex');
				
				// Interleaved vertex and texture coordinate data
				var data = [-1, -1, 0,		0,  0,
							 1, -1, 0,		1,  0,
							-1,  1, 0,		0,  1,
							 1,  1, 0,		1,  1];
				
				// Create a buffer for the vertex and texture coordinate data
				var vertexBuffer = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(data), gl.STATIC_DRAW);
				gl.enableVertexAttribArray(prog.attrLocPosition);
				gl.enableVertexAttribArray(prog.attrLocTexCoord);
				gl.vertexAttribPointer(prog.attrLocPosition, 3, gl.FLOAT, false, 20, 0);
				gl.vertexAttribPointer(prog.attrLocTexCoord, 2, gl.FLOAT, false, 20, 12);
				
				/*
				var randomImage = new Uint8Array(512 * 512 * 4);
				var index = 0;
				for (var i = 0; i < randomImage.length; i++) {
					randomImage[index] = (Math.random() > 0.5) ? 255 : 0;
					randomImage[index + 3] = 255;
					index += 4;
				}
				*/
				
				// create 2 textures and attach them to framebuffers.
				textures = [];
				frameBuffers = [];
				for (var ii = 0; ii < 2; ++ii) {
					
					var texture = gl.createTexture();
					
					gl.bindTexture(gl.TEXTURE_2D, texture);
					
					// Set up texture so we can render any size image and so we are
					// working with pixels.
					gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
					gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
					gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);
					gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
					gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
					
					// make the texture the same size as the image
					gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, WIDTH, HEIGHT, 0,
								  gl.RGBA, gl.UNSIGNED_BYTE, null);
					
					textures.push(texture);
					
					
					// Create a framebuffer
					var fbo = gl.createFramebuffer();
					gl.bindFramebuffer(gl.FRAMEBUFFER, fbo);
					
					// Attach a texture to it.
					gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
					
					frameBuffers.push(fbo);
				}
			}
			
			function draw() {
				if (isRendering) {
					requestAnimFrame(draw);
				}
				
				gl.useProgram(prog);
				
				var nextBuffer = (bufferIndex + 1) % 2;
				gl.bindFramebuffer(gl.FRAMEBUFFER, frameBuffers[nextBuffer]);
				
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, textures[bufferIndex]);
				gl.uniform1i(prog.unifLocTex, 0);
				
				gl.viewport(0, 0, WIDTH, HEIGHT);
				gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
				
				
				gl.bindFramebuffer(gl.FRAMEBUFFER, null);
				
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, textures[nextBuffer]);
				gl.uniform1i(prog.unifLocTex, 0);
				
				gl.viewport(0, 0, glCanvas.width, glCanvas.height);
				gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
				
				bufferIndex = nextBuffer;
			}
			
		</script>
    </head>
	
	<body onload="init();">
		</br>
		<h1>Conway's Game of Life</h1>
		<button id="butt" onclick="swap();">Run simulation</button>
		<button onclick="clearCanvas();">Draw something</button><br>
		<canvas id="drawCanvas"></canvas>
		<canvas id="glCanvas"></canvas>
	</body>
    
</html>
<!--
 From Zigfu's website:
 "This app is a blank page that will simply display an alert when the Zig plugin loads.
 ...
 Note that you don't have to have an event handler for the loaded event. It's a good way of testing the basic functionality of the plugin, and for doing something different on your site based on whether or not the user has the plugin installed."
 -->

<!DOCTYPE html>
<html>
    <head>
        <title>Zig Plugin Test</title>
        
        <script src="../lib/zig.js"></script>
        
        <script>
            
            var codexStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
			var codexInt = [];
			for(var i = 0; i < 256; i++) {
				var idx = codexStr.indexOf(String.fromCharCode(i));
				codexInt[i] = idx;
			}
			var Base64 =
			{
			    // assuming that the input string encodes a number of bytes divisible by 3
			    decode : function (input)
			    {
			        var output = new Array(input.length);//*3/4);
			        var inLength = input.length;
			        var outIndex = 0;
			        for (var i = 0; i < inLength; i += 4) {
			            var enc1 = codexInt[input.charCodeAt(i)];
			            var enc2 = codexInt[input.charCodeAt(i+1)];
			            var enc3 = codexInt[input.charCodeAt(i+2)];
			            var enc4 = codexInt[input.charCodeAt(i+3)];
                        
			            var chr1 = (enc1 << 2) | (enc2 >> 4);
			            var chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
			            var chr3 = ((enc3 & 3) << 6) | enc4;
			            
                        
			            output[outIndex] = chr1;
			            output[outIndex+1] = chr2;
			            output[outIndex+2] = chr3;
                        output[outIndex+3] = 255;
			            outIndex += 4;
			        }
                    
			        return output;
			    }
			}
            
            function init() {
                
                var canvas = document.getElementById("myCanvas");
                var context = canvas.getContext("2d");
                
                var bajs = false;
                zig.embed();
                console.log(zig);
                
                var plugin = document.getElementById("ZigPlugin"); // the <object> element
                plugin.requestStreams({updateImage:true});
                
                plugin.addEventListener("NewFrame", function() { // triggered every new kinect frame
                                        var rgbImage = Base64.decode(plugin.imageMap);
                                        var hej = context.createImageData(canvas.width, canvas.height);
                                        // hej.data = rgbImage;
                                        
                                        for (var i = 0; i < hej.width * hej.height * 4; ) {
                                        hej.data[i] = rgbImage[i++];
                                        }
                                        if (!bajs) {
                                        console.log(hej);
                                        bajs = true;
                                        }
                                        context.putImageData(hej, 0, 0);
                                        // canvas.style.backgroundColor = "red";
                                        });
            }
            </script>
    </head>
    <body onload="init();">
        
        <div id="pluginContainer">
            <object id="ZigPlugin" type="application/x-zig" width="0" height="0">
                <param name="onload" value="zigPluginLoaded">
                    </object>
        </div>
        
        <div style="position: relative;">
            <canvas id="myCanvas" width="160" height="120"
                style="position: absolute; left: 0; top: 0; z-index: 0;">
            </canvas>
        </div>
        
    </body>
</html>
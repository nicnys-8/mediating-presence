
<!-- :hover doesn't work with the doctype tag..?
 <!DOCTYPE html>
 -->

<html>
    <head>
        
        <title>Menu?</title>
		
        <style type="text/css">
			
			* {
				padding:0;
				margin:0;
				position:absolute;
			}
			
			html, body {
				height:100%;
				width:100%;
			}
			
			#wrap {
				width:100%;
				height:100%;
			}
			
			#sidebar-left {
				left:0px;
				top:0px;
				width:200px;
				height:100%;
				/*background-color:lightblue;*/
			}
			
			#sidebar-right {
				right:0px;
				top:0px;
				width:200px;
				height:100%;
				/*background-color:lightblue;*/
			}
			
			.video-thumb {
				position:relative;
				display:block;
				margin:20px auto;
				width:160px;
				height:120px;
				/*background-color:lightyellow;*/
			}
			
			#content {
				left:200px;
				right:200px;
				height:100%;
				/*background-color:lightgreen;*/
			}
			
			#large-video {
				position:relative;
				width:80%;
				height:50%;
				margin:10% 10% 5% 10%;
				/*background-color:pink;*/
			}
			
			#text-chat {
				position:relative;
				width:80%;
				height:35%;
				margin:0% 10% 0% 10%;
			}
			</style>
		
		<script type="text/javascript" src="js/tab-control.js"></script>
		<script type="text/javascript" src="js/mediaext.js"></script>
		<script type="text/javascript" src="js/lib/jquery.js"></script>
		
		<script>
			
			var timer = null;
			var streamIDs = [];
			var streams = {};
			var thumbs = {};
			var currentStreamID = null; // current stream (get it? haha..)
			
			var myStream;
			
			var bufferCanvas;
			var bufferContext;
			
			TabControl.onActivate = function() {
				drawThumbs();
			}
			
			TabControl.onDeactivate = function() {
				clearTimeout(timer);
				timer = null;
			}
			
			TabControl.onLocalStreamInit = function(stream) {
				console.log("chat::LocalStreamInit");
				myStream = stream;
				
				var streamID = "myStream";
				streams[streamID] = stream;
				streamIDs.push(streamID);
				
				if (!currentStreamID) {
					currentStreamID = streamID;
				}
				
				/*
				// Create a div to show a thumbnail of the video
				var thumb = document.createElement("canvas");
				thumb.width = 160;
				thumb.height = 120;
				thumb.id = "thumb" + streamID;
				thumb.className = "video-thumb";
				thumb.onclick = function() {
					currentStreamID = streamID;
				}
				thumbs[streamID] = thumb;
				
				document.getElementById("sidebar-left").appendChild(thumb);
				
				// Draw the video stream in the thumbnail div
				if (stream.hasVideo()) {
					// stream.show(thumb.id);
				} else {
					// Show an image instead?
					thumb.innerHTML = "<center><span style='width:160px; margin:50px auto;'>No video... :)</span></center>";
				}
				 */
			}
			
			TabControl.onStreamAdded = function(stream) {
				
				var streamID = stream.getID();
				streams[streamID] = stream;
				streamIDs.push(streamID);
				
				currentStreamID = streamID;
				
				/*
				// Create a div to show a thumbnail of the video
				var thumb = document.createElement("canvas");
				thumb.width = 160;
				thumb.height = 120;
				thumb.id = "thumb" + streamID;
				thumb.className = "video-thumb";
				thumb.onclick = function() {
					currentStreamID = streamID;
				}
				thumbs[streamID] = thumb;
				
				document.getElementById("sidebar-left").appendChild(thumb);
				
				// Draw the video stream in the thumbnail div
				if (stream.hasVideo()) {
					// stream.show(thumb.id);
				} else {
					// Show an image instead?
					thumb.innerHTML = "<center><span style='width:160px; margin:50px auto;'>No video... :)</span></center>";
				}
				 */
			}
			
			TabControl.onStreamRemoved = function(stream) {
				
				var streamID = stream.getID();
				// var thumb = thumbs[streamID];
				var index = streamIDs.indexOf(streamID);
				
				// Remove the stream ID
				if (index != -1) {
					streamIDs.splice(index, 1);
				}
				
				// Remove the stream
				streams[streamID].hide();
				delete streams[streamID];
				
				/*
				// Remove the thumbnail div
				if (thumb) {
					thumb.parentNode.removeChild(thumb);
					delete thumbs[streamID];
				}
				*/
				
				// Update which stream is shown in the middle
				if (streamID == currentStreamID) {
					if (streamIDs.length == 0) {
						currentStreamID = null;
					} else {
						currentStreamID = streamIDs[index % streamIDs.length];
					}
				}
			}
			
			TabControl.onMessageReceived = function(senderId, type, data) {
				if (type == "msg") {
					showChatMessage(senderId, data);
				}
			}
			
			TabControl.onKinectInit = function(proxy) {
			}
			
			TabControl.onNewKinectData = function(videoData, depthData) {
			}
			
            TabControl.onLoad = function() {
				/*
				 // For local testing:
				 var video = MediaExt.getCameraAccess(640, 480, function() {
				 TabControl.onStreamAdded({
				 getID:function() { return "hej"; },
				 hasVideo:function() { return false; },
				 });
				 TabControl.onStreamAdded({
				 getID:function() { return "hej2"; },
				 hasVideo:function() { return false; },
				 });
				 });
				 */
				
				console.log("chat::Load");
				
				var onWidowResize = function() {
					var canvas = document.getElementById("large-video");
					canvas.width = canvas.offsetWidth;
					canvas.height = canvas.offsetHeight;
				}
				
				onWidowResize();
				
				window.addEventListener("resize", onWidowResize, false);
				
				bufferCanvas = document.createElement("canvas");
				bufferContext = bufferCanvas.getContext("2d");
				
				
				var textArea = document.getElementById("chat-input");

				textArea.onkeypress = function(evt) {
					if (evt.keyCode == 13) {
						sendChatMessage();
						return false;
					}
					return true;
				};
			}
			
			function drawThumbs() {
				
				/*
				for (var streamID in thumbs) {
					var canvas = thumbs[streamID];
					var ctx = canvas.getContext("2d");
					var imageData = streams[streamID].getVideoFrame();
					
					if (imageData) {
						if (bufferCanvas.width != imageData.width ||
						    bufferCanvas.height != imageData.height) {
							bufferCanvas.width = imageData.width;
							bufferCanvas.height = imageData.height;
						}
						bufferContext.putImageData(imageData, 0, 0);
						ctx.drawImage(bufferCanvas, 0, 0, canvas.width, canvas.height);
					}
				}
				*/
				
				if (currentStreamID) {
					
					var canvas = document.getElementById("large-video");
					var ctx = canvas.getContext("2d");
					
					// ctx.drawImage(video, 0, 0, canvas.width, canvas.width * 0.75);
					
					var imageData = streams[currentStreamID].getVideoFrame();
					
					if (imageData) {
						if (bufferCanvas.width != imageData.width ||
							bufferCanvas.height != imageData.height) {
							bufferCanvas.width = imageData.width;
							bufferCanvas.height = imageData.height;
						}
						bufferContext.putImageData(imageData, 0, 0);
						ctx.drawImage(bufferCanvas, 0, 0, canvas.width, canvas.width * 0.75);
					}
				}
				
				timer = setTimeout(drawThumbs, 100);
			}
			
			function showChatMessage(sender, message) {
				
				if (!message) {
					return;
				}
				
				var textOut = document.getElementById("chat-area");
				textOut.value = textOut.value + "\n" + sender + " said: " + message;
				textOut.scrollTop = textOut.scrollHeight;
			}
			
			function sendChatMessage() {
				
				var textIn = document.getElementById("chat-input");
				var message = textIn.value.trim();
				
				if (message) {
					showChatMessage("You", message);
					TabControl.sendMessage("chat", "msg", message);
				}
				
				textIn.value = "";
			}
			
			</script>
        
    </head>
	
	<body>
		
		<div id="wrap">
			
			<div id="sidebar-left"></div>
			
			<div id="content">
				<canvas id="large-video"></canvas>
				
				<div id="text-chat">
					<textarea id="chat-area" disabled=true style="position:relative; width:100%; height:70%; margin-bottom:5px;">Text chat!</textarea>
					<br>
					<textarea id="chat-input" rows="1" style="position:relative; width:80%; height:2em; margin:0 5px 0 0;"></textarea>
					<button
						style="width:18%; height:2em; margin-top:0;"
						onclick="sendChatMessage();">Send</button>
				</div>
			</div>
			
			<div id="sidebar-right"></div>
			
		</div>
    </body>
	
</html>


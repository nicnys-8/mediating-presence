
<!-- Partly based on example from http://learningwebgl.com/lessons/lesson02/index.html -->

<html>
    <head>
        
        <title>Point Cloud Rendering Test</title>
        
        <script type="text/javascript" src="../js/mediaext.js"></script>
        <script type="text/javascript" src="../js/lib/webgl-utils.js"></script>
        <script type="text/javascript" src="../js/lib/glMatrix-0.9.5.min.js"></script>
        <script type="text/javascript" src="../js/lib/zig.js"></script>
        <script type="text/javascript" src="../js/kinect-decoder.js"></script>
        <script type="text/javascript" src="../js/image-handling.js"></script>
		<script type="text/javascript" src="../js/point-cloud-renderer.js"></script>
		
        <link rel="stylesheet" type="text/css" href="../css/pb.css"/>
        <link rel="stylesheet" type="text/css" href="../css/pointcloud.css"/>
        
        <script type="text/javascript">
            
            const VIDEO_DISPLAY_WIDTH = 640, VIDEO_DISPLAY_HEIGHT = 480;
			const KINECT_RGB_WIDTH = 160, KINECT_RGB_HEIGHT = 120;
            const KINECT_DEPTH_WIDTH = 160, KINECT_DEPTH_HEIGHT = 120;
            
            var depthData = new Array(KINECT_DEPTH_WIDTH * KINECT_DEPTH_HEIGHT);
            var currentVideoFrame, videoData;
            var renderer;
			
            function init() {
                
                glCanvas = MediaExt.createCanvas(VIDEO_DISPLAY_WIDTH, VIDEO_DISPLAY_HEIGHT);
                glCanvas.style.margin = "20px auto";
                
				renderer = new PointCloudRenderer(glCanvas);
				
                document.getElementById("container").appendChild(glCanvas);
                
				currentVideoFrame = MediaExt.createCanvas(KINECT_RGB_WIDTH, KINECT_RGB_HEIGHT);
				videoData = currentVideoFrame.getContext("2d").createImageData(KINECT_RGB_WIDTH, KINECT_RGB_HEIGHT);
                plugin = document.getElementById("ZigPlugin");
				// Start the video streams
				plugin.requestStreams({updateDepth:true, updateImage:true});
				// Start updating the canvases every new kinect frame
                plugin.addEventListener("NewFrame", onNewKinectData);
                
                // drawScene();
            }
            
            var maxDepth = 1500;
            
            /**
             Callback from the plugin when new depth and RGB data is available from the Kinect.
             */
			function onNewKinectData() {
				
                // Decode the video data
                KinectDecoder.decodeRGB(plugin.imageMap, videoData.data);
                
                // Decode the depth data
                KinectDecoder.decodeDepth(plugin.depthMap, depthData);
                
                var pos = [], rgb = [];
                var index = 0;
                
				var maxX=-Infinity, maxY=-Infinity, maxZ=-Infinity,
					minX=Infinity, minY=Infinity, minZ=Infinity;
				
                for (var y = 0, index = 0; y < KINECT_DEPTH_HEIGHT; y++) {
                    for (var x = 0; x < KINECT_DEPTH_WIDTH; x++, index++) {
                        
                        var z = depthData[index];
                        
                        if (z > 0 && z < maxDepth) {
                            // INCORRECT SCALING! :)
                            pos[index * 3 + 0] = x;
                            pos[index * 3 + 1] = -y;
                            pos[index * 3 + 2] = -z / 3;
                            
                            rgb[index * 4 + 0] = videoData.data[index * 4 + 0] / 255.0;
                            rgb[index * 4 + 1] = videoData.data[index * 4 + 1] / 255.0;
                            rgb[index * 4 + 2] = videoData.data[index * 4 + 2] / 255.0;
                            rgb[index * 4 + 3] = videoData.data[index * 4 + 3] / 255.0;
							
							maxX = Math.max(maxX, x);
							maxY = Math.max(maxY, -y);
							maxZ = Math.max(maxZ, -z);
							
							minX = Math.min(minX, x);
							minY = Math.min(minY, -y);
							minZ = Math.min(minZ, -z);
							
                        }
                    }
                }
				console.log((maxX + minX) / 2 + ", " + (maxY + minY) / 2 + ", " + (maxZ + minZ) / 2);
                renderer.bufferData(pos, rgb);
                renderer.render();
                // console.log(pos.length);
			}
            
            </script>
        
    </head>
	
	<body onload="init();">
        
        <div id="pluginContainer">
            <object id="ZigPlugin" type="application/x-zig" width="0" height="0">
                <param name="onload" value="zigPluginLoaded">
                    </object>
        </div>
        
        <h1>Point Cloud Generation</h1>
        <div id="container">
        </div>
</html>
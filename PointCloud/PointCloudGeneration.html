
<!-- Partly based on example from http://learningwebgl.com/lessons/lesson02/index.html -->

<html>
    <head>
        
        <title>Point Cloud Rendering Test</title>
        
        <script type="text/javascript" src="../js/mediaext.js"></script>
        <script type="text/javascript" src="../js/lib/webgl-utils.js"></script>
        <script type="text/javascript" src="../js/lib/glMatrix-0.9.5.min.js"></script>
        <script type="text/javascript" src="../js/lib/zig.js"></script>
        <script type="text/javascript" src="../js/kinect-decoder.js"></script>
        <script type="text/javascript" src="../js/image-handling.js"></script>
        
        <link rel="stylesheet" type="text/css" href="css/pb.css"/>
        <link rel="stylesheet" type="text/css" href="css/pointcloud.css"/>
        
        <script id="shader-fs" type="x-shader/x-fragment">
            precision mediump float;
            varying vec4 vColor;
            void main(void) {
                gl_FragColor = vColor;
            }
            </script>
        
        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec4 aVertexColor;
            
            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;
            
            varying vec4 vColor;
            
            void main(void) {
                vec4 pos = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                gl_PointSize = 3.0 / pos.z;
                gl_Position = pos;
                vColor = aVertexColor;
            }
            </script>
        
        <script type="text/javascript">
            
            const kWidth = 800, kHeight = 600;
            var glCanvas;
            var gl, prog;
            
            function initShaders() {
                
                var vsStr = document.getElementById("shader-vs").text;
                var fsStr = document.getElementById("shader-fs").text;
                prog = WebGLUtils.createProgram(gl, vsStr, fsStr);
                
                gl.useProgram(prog);
                
                prog.vertexPositionAttribute = gl.getAttribLocation(prog, "aVertexPosition");
                gl.enableVertexAttribArray(prog.vertexPositionAttribute);
                
                prog.vertexColorAttribute = gl.getAttribLocation(prog, "aVertexColor");
                gl.enableVertexAttribArray(prog.vertexColorAttribute);
                
                prog.pMatrixUniform = gl.getUniformLocation(prog, "uPMatrix");
                prog.mvMatrixUniform = gl.getUniformLocation(prog, "uMVMatrix");
            }
            
            
            var mvMatrix = mat4.create();
            var pMatrix = mat4.create();
            
            function degToRad(degrees) {
                return degrees * Math.PI / 180;
            }
            
            function setMatrixUniforms() {
                gl.uniformMatrix4fv(prog.pMatrixUniform, false, pMatrix);
                gl.uniformMatrix4fv(prog.mvMatrixUniform, false, mvMatrix);
            }
            
            var pointCloudPositionBuffer = null;
            var pointCloudColorBuffer = null;
            
            function createBuffers(vertices, colors) {
                
                pointCloudPositionBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, pointCloudPositionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
                pointCloudPositionBuffer.itemSize = 3;
                pointCloudPositionBuffer.numItems = vertices.length / 3;
                
                pointCloudColorBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, pointCloudColorBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
                pointCloudColorBuffer.itemSize = 4;
                pointCloudColorBuffer.numItems = colors.length / 4;
            }
            
            function drawScene() {
                
                // requestAnimFrame(drawScene);

                gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

                mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, maxDepth, pMatrix);
                
                mat4.identity(mvMatrix);
                mat4.translate(mvMatrix, [0.0, 0.0, -2.0]);
                mat4.multiply(mvMatrix, pcRotationMatrix);
                
                gl.bindBuffer(gl.ARRAY_BUFFER, pointCloudPositionBuffer);
                gl.vertexAttribPointer(prog.vertexPositionAttribute, pointCloudPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
                
                gl.bindBuffer(gl.ARRAY_BUFFER, pointCloudColorBuffer);
                gl.vertexAttribPointer(prog.vertexColorAttribute, pointCloudColorBuffer.itemSize, gl.FLOAT, false, 0, 0);
                
                setMatrixUniforms();
                gl.drawArrays(gl.POINTS, 0, pointCloudPositionBuffer.numItems);
            }
            
            var mouseDown = false;
            var lastMouseX = null;
            var lastMouseY = null;
            
            var pcRotationMatrix = mat4.create();
            mat4.identity(pcRotationMatrix);
            
            function handleMouseDown(event) {
                mouseDown = true;
                lastMouseX = event.clientX;
                lastMouseY = event.clientY;
            }
            
            function handleMouseUp(event) {
                mouseDown = false;
            }
            
            function handleMouseMove(event) {
                
                if (!mouseDown) {
                    return;
                }
                var newX = event.clientX;
                var newY = event.clientY;
                
                var deltaX = newX - lastMouseX;
                var newRotationMatrix = mat4.create();
                mat4.identity(newRotationMatrix);
                mat4.rotate(newRotationMatrix, degToRad(deltaX / 10), [0, 1, 0]);
                
                var deltaY = newY - lastMouseY;
                mat4.rotate(newRotationMatrix, degToRad(deltaY / 10), [1, 0, 0]);
                
                mat4.multiply(newRotationMatrix, pcRotationMatrix, pcRotationMatrix);
                
                lastMouseX = newX;
                lastMouseY = newY;
            }
            
            
            const VIDEO_DISPLAY_WIDTH = 640, VIDEO_DISPLAY_HEIGHT = 480;
			const KINECT_RGB_WIDTH = 160, KINECT_RGB_HEIGHT = 120;
            const KINECT_DEPTH_WIDTH = 160, KINECT_DEPTH_HEIGHT = 120;
            
            var depthData = new Array(KINECT_DEPTH_WIDTH * KINECT_DEPTH_HEIGHT);
            var currentVideoFrame, videoData;
            
            function init() {
                
                glCanvas = MediaExt.createCanvas(kWidth, kHeight);
                glCanvas.style.margin = "20px auto";
                
                gl = WebGLUtils.setupWebGL(glCanvas);
                gl.viewportWidth = glCanvas.width;
                gl.viewportHeight = glCanvas.height;
                document.getElementById("container").appendChild(glCanvas);
                
                initShaders();
                
                gl.clearColor(0.0, 0.0, 0.0, 1.0);
                gl.enable(gl.DEPTH_TEST);
                
                glCanvas.onmousedown = handleMouseDown;
                document.onmouseup = handleMouseUp;
                document.onmousemove = handleMouseMove;
                
                currentVideoFrame = MediaExt.createCanvas(KINECT_RGB_WIDTH, KINECT_RGB_HEIGHT);
				videoData = currentVideoFrame.getContext("2d").createImageData(KINECT_RGB_WIDTH, KINECT_RGB_HEIGHT);
                plugin = document.getElementById("ZigPlugin");
				// Start the video streams
				plugin.requestStreams({updateDepth:true, updateImage:true});
				// Start updating the canvases every new kinect frame
                plugin.addEventListener("NewFrame", onNewKinectData);
                
                // drawScene();
            }
            
            var maxDepth = 1000;
            
            /**
             Callback from the plugin when new depth and RGB data is available from the Kinect.
             */
			function onNewKinectData() {
				
                // Decode the video data
                KinectDecoder.decodeRGB(plugin.imageMap, videoData.data);
                
                // Decode the depth data
                KinectDecoder.decodeDepth(plugin.depthMap, depthData);
                
                var pos = [], rgb = [];
                var index = 0;
                
                for (var y = 0, index = 0; y < KINECT_DEPTH_HEIGHT; y++) {
                    for (var x = 0; x < KINECT_DEPTH_WIDTH; x++, index++) {
                        
                        var z = depthData[index];
                        
                        if (z > 0 && z < maxDepth) {
                            // INCORRECT SCALING! :)
                            pos[index * 3 + 0] = (x - 80) / 160.0;
                            pos[index * 3 + 1] = (y - 60) / 120.0;
                            pos[index * 3 + 2] = z / maxDepth;
                            
                            rgb[index * 4 + 0] = videoData.data[index * 4 + 0] / 255.0;
                            rgb[index * 4 + 1] = videoData.data[index * 4 + 1] / 255.0;
                            rgb[index * 4 + 2] = videoData.data[index * 4 + 2] / 255.0;
                            rgb[index * 4 + 3] = videoData.data[index * 4 + 3] / 255.0;
                        }
                    }
                }
                createBuffers(pos, rgb);
                drawScene();
                // console.log(pos.length);
			}
            
            </script>
        
    </head>
	
	<body onload="init();">
        
        <div id="pluginContainer">
            <object id="ZigPlugin" type="application/x-zig" width="0" height="0">
                <param name="onload" value="zigPluginLoaded">
                    </object>
        </div>
        
        <h1>Point Cloud Generation</h1>
        <div id="container">
        </div>
</html>
<!doctype html>
<html lang="en" style="height:100%; width:100%;">
    <head>
        <title>Klotski</title>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
                
                <script type="text/javascript" src="js/tab-control.js"></script>
                <script type="text/javascript" src="js/lib/three.js"></script>
                <script type="text/javascript" src="js/mouse-interface.js"></script>
                <script type="text/javascript" src="js/klotski3D.js"></script>
                <script type="text/javascript" src="js/klotski-blocks.js"></script>
                <script type="text/javascript" src="js/particles.js"></script>
                <script type="text/javascript" src="js/lib/zig.js"></script>
                <script type="text/javascript" src="js/kinect-decoder.js"></script>
                <script type="text/javascript" src="js/image-handling.js"></script>
                <script type="text/javascript" src="js/kinect-touch-controller.js"></script>
                <script type="text/javascript" src="js/geometry.js"></script>
                <script type="text/javascript" src="js/lib/subdivision-modifier.js"></script>
                <script type="text/javascript" src="js/timer.js"></script>
                
                <link rel="stylesheet" type="text/css" href="css/pb.css"/>
                
                <script>
                    
                    var klotski;
                    var startDiv;
                    var levelDiv;
                    var clearedDiv;
                    var messageDiv;
                    var container;
                    var turnButton;
                    
                    TabControl.onActivate = function() {
                        klotski.shouldRender = true;
                    };
                    
                    TabControl.onDeactivate = function() {
                        klotski.shouldRender = false;
                    };
                    
                    TabControl.onStreamAdded = function(stream) {
                    };
                    
                    TabControl.onStreamRemoved = function(stream) {
                    };
                    
                    TabControl.onMessageReceived = function(senderId, type, packet) {
                        if (type == "gameStart") {
                            // Display the game screen
                            startDiv.style.display = "none";
                            levelDiv.style.display = "block";
                            startGame(packet.yourTurn);
                        }
                        else if (type == "yourTurn") {
                            klotski.hasTurn = true;
                            turnButton.disabled = false;
                        }
                        else if (type == "update") {
                            klotski.onReceivedMove(packet);
                        }
                        else if (type == "nextLevel") {
                            klotski.nextLevel();
                        }
                        else {
                            console.log("Received unreadable message");
                        }
                    };
                    
                    TabControl.onLoad = function() {
                        // Store the DOM elements for use later
                        levelDiv = document.getElementById("game");
                        clearedDiv = document.getElementById("levelCleared");
                        messageDiv = document.getElementById("message");
                        container = document.getElementById("klotskiContainer");
                        startDiv = document.getElementById("startScreen");
                        turnButton = document.getElementById("turnButton");
                        
                        levelDiv.style.display = "none";
                        clearedDiv.style.display = "none";
                        
                        // Create the Klotski object
                        klotski = new Klotski(blockSnapped,
                                              finishedLevel,
                                              container
                                              );
                    }
                    
                    /**
                     Sends a game invitation to another player
                     */
                    function invitePlayer() {
                        /* TODO: Replace with some kind of invitation:
                         
                         */
                        startDiv.style.display = "none";
                        levelDiv.style.display = "block";
                        startGame(true);
                    }
                    
                    function startGame(hasTurn) {
                        // Set the player's color
                        var playerColor = (hasTurn) ? "red" : "blue";
                        klotski.startGame(playerColor);
                        // Start listening for mouse events
                        document.addEventListener('mousedown', onMouseDown, false);
                        document.addEventListener('mousemove', onMouseMove, false);
                        document.addEventListener('mouseup', onMouseUp, false);
                        // Start the update loop
                        turnButton.disabled = !hasTurn;
                        tick();
                    }
                    
                    /**
                     Update loop for running the game
                     */
                    function tick() {
                        requestAnimationFrame(tick);
                        klotski.updateScene();
                    }
                    
                    /**
                     Called when a Klotski block snaps to an even grid point
                     */
                    function blockSnapped(id, x, y) {
                        var data = {id:id, x:x, y:y};
                        TabControl.sendMessage("play", "update", data);
                    }
                    
                    /**
                     Called when a level is finished
                     @param finishTime A string representing the time it took to finish
                     the level.
                     */
                    function finishedLevel(levelIndex, finishTime) {
                        levelDiv.style.display = "none";
                        clearedDiv.style.display = "block";
                        var levelNumber = levelIndex + 1;
                        messageDiv.innerHTML = "Level " + levelNumber + " cleared! Finish time: " + finishTime;
                    }
                    
                    /**
                     Start the next level
                     */
                    function nextLevel() {
                        levelDiv.style.display = "block";
                        clearedDiv.style.display = "none";
                        klotski.nextLevel();
                        // Tell the other player to start the next level as well
                        TabControl.sendMessage("play", "nextLevel", {});
                    }
                    
                    /**
                     Give up control of the game to your opponent
                     */
                    function giveUpTurn() {
                        klotski.hasTurn = false;
                        turnButton.disabled = true;
                        TabControl.sendMessage("play", "yourTurn", {});
                    }
                    
                    /*---------------------
                     ===| Mouse Events |===
                     --------------------*/
                    /**
                     Called whenever the left mouse button is clicked
                     */
                    function onMouseDown(event) {
                        klotski.onMouseDown(event.clientX, event.clientY);
                    }
                    
                    /**
                     Called whenever the mouse is moved
                     */
                    function onMouseMove(event) {
                        klotski.onMouseMove(event.clientX, event.clientY);
                    }
                    
                    /**
                     Called when the left mouse button is released
                     */
                    function onMouseUp(event) {
                        klotski.onMouseUp(event.clientX, event.clientY);
                    }
                    
                    </script>
                </head>
    
    <body style="overflow:hidden; height:100%; width:100%">
        
        <div id ="startScreen" style="text-align:center">
            <h1>Welcome to Klotski!</h1>
            <div style="width:50%; margin:0 auto">
            The goal of the game is to get the <span style="color:#00DD00">green</span> block to the bottom of the
            level. You can only move some of the blocks, so you'll need help
            from a friend to finish the levels!
            </div>
            
            <button id="invitePlayer" onclick="invitePlayer()">
                Invite friend
            </button>
        </div>
        
        <div id ="game" style="text-align:center; height:100%; width:100%">
            <div id="timer">
                Time passed: 00:00
            </div>
            <button type="button" id="turnButton" onclick="giveUpTurn()">Give up turn</button>
            <div id ="klotskiContainer" style="height:100%; width:100%"> </div>
        </div>
        
        <div id ="levelCleared" style="text-align:center; height:100%; width:100%">
            <h1>Well done!</h1>
            <div id="message"></div>
            <button type="button" id="nextLevelButton" onclick="nextLevel()">Next level</button>
        </div>
        
        
        
    </body>
</html>
